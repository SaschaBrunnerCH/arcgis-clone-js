<!doctype html>
<html lang="en">
<head>
    <meta charset=utf-8>
    <!--
     | Copyright (c) 2018 Esri
     | Apache-2.0
    -->
  <title>Clone solution template</title>
  <link rel="stylesheet" type="text/css" href="../demo_common/common.css">
</head>
<body>
  <h3>Clone solution template</h3>
  <div id="page" style="display:none">

    <div class="section">
      <div class="section-title">Credentials in destination organization</div>
      <label for="username">Username:</label> <input type="text" id="username"></input>
      <label for="password">Password:</label> <input type="password" id="password"></input>
    </div>

    <div id="availableSolutions" class="section">
      <div class="section-title">Available Solutions</div>
      <img id="fetchingSolutions" src="../demo_common/images/loading.gif"/>
      <div id="solutionsResults" style="display:none">
        <div id="solutionsDisplay"></div>
      </div>
    </div>

    <div id="display" class="section" style="display:none">
      <div class="section-title">Details of selected Solution</div>
      <img id="fetchingDetails" src="../demo_common/images/loading.gif"/>
      <div id="detailsResults" style="display:none">
        <div id="detailsDisplay"></div>
        <br>
        <button id="createBtn" onclick="createSolutionFcn()">Create solution in your organization</button>
        using name <input type="text" id="solutionNameField"></input>
      </div>
    </div>

    <div id="create" class="section" style="display:none">
      <div class="section-title">Details of your Solution <span id="solutionName"></span></div>
      <img id="creating" src="../demo_common/images/loading.gif"/>
      <div id="createResults" style="display:none">
        <div id="createDisplay"></div>
      </div>
      <div id="progressBarContainer"><div id="progressBar"></div></div>
    </div>

  </div>

  <script src="../demo_common/require_2.3.6.min.js"></script>
  <script>
  var showSolutionFcn = createSolutionFcn = null;
  var currentSolutionId, currentSolutionName, currentSolutionItems;

  /**
   * Shows the currently-selected solution.
   * @param event Radio-button click event
   */
  function onRadioClicked(event) {
    // Save id & name of the selected solution so that we can build it
    var currentSolutionParts = event.value.split('|');
    currentSolutionId = currentSolutionParts[0];
    currentSolutionName = event.value.substr(currentSolutionId.length + 1);
    document.getElementById('solutionNameField').value = currentSolutionName;

    // Show the hierarchy of the selected solution
    showSolutionFcn(currentSolutionId);
  }

  requirejs.config({
    baseUrl: './',
    paths: {
      // for the benefit of arcgis-clone-js
      'tslib': '../demo_common/tslib',
      // for the benefit of called libraries that use arcgis-rest-auth
      '@esri/arcgis-rest-auth': 'https://unpkg.com/@esri/arcgis-rest-auth@1.11.1/dist/umd/auth.umd',
      '@esri/arcgis-rest-feature-service-admin':
        'https://unpkg.com/@esri/arcgis-rest-feature-service-admin@1.11.1/dist/umd/feature-service-admin.umd',
      '@esri/arcgis-rest-groups': 'https://unpkg.com/@esri/arcgis-rest-groups@1.11.1/dist/umd/groups.umd',
      '@esri/arcgis-rest-items': 'https://unpkg.com/@esri/arcgis-rest-items@1.11.1/dist/umd/items.umd',
      '@esri/arcgis-rest-request': 'https://unpkg.com/@esri/arcgis-rest-request@1.11.1/dist/umd/request.umd',
      '@esri/arcgis-rest-sharing': 'https://unpkg.com/@esri/arcgis-rest-sharing@1.11.1/dist/umd/sharing.umd'
    }
  });
  requirejs([
    '../../dist/src/index',
    '../demo_common/common',
    '../demo_common/progress',
    'cloneJS',
    '@esri/arcgis-rest-auth',
    '@esri/arcgis-rest-items',
    '@esri/arcgis-rest-request'
  ], function (
    clone,
    demoCommon,
    progress,
    cloneJS,
    auth,
    items,
    request
  ) {
    showSolutionFcn = demoCommon.showPublishedSolutionHierarchy.bind(demoCommon);
    createSolutionFcn = createSolution;

    document.getElementById('page').style.display = 'block';

    // Fetch and list solutions
    demoCommon.showAvailableSolutions();

    //----------------------------------------------------------------------------------------------------------------//

    /**
     * Creates the items described in a solution in the user's organization.
     */
    function createSolution() {
      document.getElementById('createBtn').disabled = 'disabled';
      document.getElementById('create').style.display = 'block';
      document.getElementById('availableSolutions').style.display = 'none';

      progress.init('progressBarContainer', 'progressBar');
      progress.show();

      // Prepare credentials for library
      requestOptions = demoCommon.getRequestOptions('username', 'password');

      // Get the destination organization URL for creating links to source items
      request.getPortal(null, requestOptions)
      .then(
        portalResponse => {
          orgUrl = 'https://' + portalResponse.urlKey + '.' + portalResponse.customBaseUrl + '/home/';
          portal = 'https://' + portalResponse.portalHostname + '/';
          currentSolutionName = document.getElementById('solutionNameField').value || currentSolutionName;

          // Get the solution contents
          items.getItemData(currentSolutionId)
          .then(
            publishedSolution => {
              currentSolutionItems = publishedSolution.items;

              // Clone the contents into the destination org
              cloneJS.createItemHierachyFromJSON(orgUrl, portal, currentSolutionName, currentSolutionItems,
                progress.set.bind(progress), requestOptions.authentication)
              .then(
                createResponse => {
                  document.getElementById('solutionName').innerHTML = '"' + currentSolutionName + '"';

                  // List the created items in the solution folder
                  // There appears to be a lag between when the service says that the items are added and when
                  // they show up in response to a search. Wait a couple of seconds before searching
                  setTimeout(
                    () => {
                      progress.hide();
                      demoCommon.showCreatedItems(portalResponse, createResponse);
                    },
                    2000
                  );
                },
                () => {
                  document.getElementById('create').style.display = 'none';
                  alert('Please refresh page and provide credentials');
                }
              );
            }
          );
        }
      );
    }

    //----------------------------------------------------------------------------------------------------------------//

  });
  </script>
</body>
</html>
