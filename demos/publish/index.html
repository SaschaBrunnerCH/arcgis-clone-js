<!doctype html>
<html lang="en">
<head>
    <meta charset=utf-8>
    <!--
     | Copyright 2018 Esri
     |
     | Licensed under the Apache License, Version 2.0 (the "License");
     | you may not use this file except in compliance with the License.
     | You may obtain a copy of the License at
     |
     |    http://www.apache.org/licenses/LICENSE-2.0
     |
     | Unless required by applicable law or agreed to in writing, software
     | distributed under the License is distributed on an "AS IS" BASIS,
     | WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     | See the License for the specific language governing permissions and
     | limitations under the License.
    -->
  <title>Publish solution template</title>
  <style>
  .section {
    margin: 8px 0 8px 0;
    border: 1px solid gray;
    padding: 8px;
  }
  .section-title {
    font-size: larger;
    margin-bottom: 4px;
  }
  ul {
    margin: 0;
    margin-top: 0.25em;
  }
  li {
    margin-top: 0.25em;
  }
  a {
    color: dodgerblue;
  }
  a:link {
    color: dodgerblue;
  }
  </style>
</head>
<body>
  <div id="page" style="display:none">
    <div class="section">
      <div class="section-title">Credentials in publishing organization</div>
      <label for="username">Username:</label> <input type="text" id="username"></input>
      <label for="password">Password:</label> <input type="password" id="password"></input>
    </div>

    <div class="section">
      <div class="section-title">Items to package into a single Solution (along with their dependencies)</div>
      <input type="checkbox" onclick="onCheckboxChanged()" name="6fc5992522d34f26b2210d17835eea21"></input> <label for="6fc5992522d34f26b2210d17835eea21">ROW Permit Public Comment (Web Mapping Application)</label> <br>
      <input type="checkbox" onclick="onCheckboxChanged()" name="8974dec44d794311a69f5562659587e6"></input> <label for="8974dec44d794311a69f5562659587e6">ROW Permit Manager (Web Mapping Application)</label> <br>
      <input type="checkbox" onclick="onCheckboxChanged()" name="9bccd0fac5f3422c948e15c101c26934"></input> <label for="9bccd0fac5f3422c948e15c101c26934">ROW Permit Dashboard (Dashboard)</label> <br>
      <br>
      <button id="createBtn" onclick="onRunCreate()" disabled="disabled">Create solution</button>
    </div>

    <div id="create" class="section" style="display:none">
      <div class="section-title">Solution ready for publishing</div>
      <img id="creating" src="loading.gif"/>
      <div id="createResults" style="display:none">
        <div id="createDisplay"></div>
        <br>
        <label for="username">Name for published Solution</label> <input type="text" id="solutionName"></input><br>
        <button id="publishBtn" onclick="onRunPublish()">Publish solution</button>
      </div>
    </div>

    <div id="publish" class="section" style="display:none">
      <div class="section-title">Published Solution</div>
      <img id="publishing" src="loading.gif"/>
      <div id="publishResults" style="display:none">
        <div id="publishDisplay"></div>
      </div>
    </div>

  </div>

  <script src="require_2.3.6.min.js"></script>
  <script>
  var onRunCreate = onRunPublish = null;

  function onCheckboxChanged() {
    document.getElementById('createBtn').disabled = getCheckedItems().length === 0 ? 'disabled' : '';
  }

  function getCheckedItems() {
    var checkedItems = [];
    Array.prototype.slice.call(document.getElementsByTagName('input')).forEach(function (item) {
      if (item.type === 'checkbox' && item.checked) {
        checkedItems.push(item.name);
      }
    });
    return checkedItems;
  }

  requirejs.config({
    baseUrl: './',
    paths: {  // for the benefit of called libraries
      '@esri/arcgis-rest-auth': 'https://unpkg.com/@esri/arcgis-rest-auth@1.11.1/dist/umd/auth.umd',
      '@esri/arcgis-rest-feature-service-admin': 'https://unpkg.com/@esri/arcgis-rest-feature-service-admin@1.11.1/dist/umd/feature-service-admin.umd',
      '@esri/arcgis-rest-groups': 'https://unpkg.com/@esri/arcgis-rest-groups@1.11.1/dist/umd/groups.umd',
      '@esri/arcgis-rest-items': 'https://unpkg.com/@esri/arcgis-rest-items@1.11.1/dist/umd/items.umd',
      '@esri/arcgis-rest-request': 'https://unpkg.com/@esri/arcgis-rest-request@1.11.1/dist/umd/request.umd',
      '@esri/arcgis-rest-sharing': 'https://unpkg.com/@esri/arcgis-rest-sharing@1.11.1/dist/umd/sharing.umd'
    }
  });
  requirejs([
    '../../dist/src/index',
    '@esri/arcgis-rest-auth',
    '@esri/arcgis-rest-request'
  ], function (
    clone,
    auth,
    request
  ) {
    onRunCreate = createSolution;
    onRunPublish = publishSolution;
    var requestOptions, orgUrl, portal, solution, publishedSolutionId;

    document.getElementById('page').style.display = 'block';

    //----------------------------------------------------------------------------------------------------------------//

    function createSolution() {
      document.getElementById('createBtn').disabled = 'disabled';
      document.getElementById('create').style.display = 'block';

      // Prepare credentials for library
      requestOptions = getRequestOptions('username', 'password');

      // Get the publisher's organization URL for creating links to source items
      request.getPortal(null, requestOptions)
      .then(function (response) {
        orgUrl = 'https://' + response.urlKey + '.' + response.customBaseUrl + '/home/';
        portal = 'https://' + response.portalHostname + '/';

        // Get the items to include in the solution
        var solutionRootIds = getCheckedItems();

        // Prepare the Solution
        clone.ItemFactory.itemHierarchyToJSON(solutionRootIds, requestOptions)
        .then(function (solutionResponse) {
          solution = solutionResponse;
          document.getElementById('createDisplay').innerHTML =
            'Source hierarchy:' + createSolutionContentsDisplay(solution, true, orgUrl);
        }, function (error) {
           document.getElementById('createDisplay').innerHTML = error.toString();
        })
        .finally(function () {
          document.getElementById('creating').style.display = 'none';
          document.getElementById('createResults').style.display = 'block';
        });
      });
    }

    function publishSolution() {
      document.getElementById('publishBtn').disabled = 'disabled';
      document.getElementById('publish').style.display = 'block';

      // Publish the Solution
      var solutionName = document.getElementById('solutionName').value || 'My Solution';
      clone.Solution.publishItemJSON(solutionName, solution, 'public', requestOptions)
      .then(function (publishResponse) {
        publishedSolutionId = publishResponse.id;
        document.getElementById('publishDisplay').innerHTML = createPublishedDisplay(publishedSolutionId);
      }, function (error) {
         document.getElementById('publishDisplay').innerHTML = error.toString();
      })
      .finally(function () {
        document.getElementById('publishing').style.display = 'none';
        document.getElementById('publishResults').style.display = 'block';
      });
    }

    //----------------------------------------------------------------------------------------------------------------//

    function getRequestOptions(usernameElementId, passwordElementId) {
      return {
        authentication: new auth.UserSession({
          username: document.getElementById(usernameElementId).value,
          password: document.getElementById(passwordElementId).value
        })
      };
    }

    function createSolutionContentsDisplay(solution, createLinks, orgUrl) {
      // Show solution contents as they'd be in the solution's AGOL item
      var hierarchy = clone.Solution.getItemHierarchy(solution);

      function createHierarchyDisplay(hierarchy, createLinks) {
        var icons = {
          'Dashboard': 'images/dashboard16.svg',
          'Feature Service': 'images/features16.svg',
          'Group': 'images/group.svg',
          'Web Map': 'images/maps16.svg',
          'Web Mapping Application': 'images/apps16.svg'
        };

        var display = '<ul>';
        hierarchy.forEach(function (item) {
          var itemSection = solution[item.id].itemSection;
          var itemLabel = (itemSection.title || itemSection.name || item.type);
          if (item.type === 'Feature Service') {
            itemLabel += ' (' + item.idPart + ')';
          }

          var webpage = item.type === 'Group' ? 'group' : 'item';
          display += '<li><img class="item-type-icon margin-right-quarter" src="' + icons[item.type] +
            '" width="16" height="16" alt="">&nbsp;&nbsp;';
          if (createLinks) {
            display += '<a href="' + orgUrl + webpage + '.html?id=' + item.id + '" target="_blank">' +
              itemLabel + '</a>';
          } else {
            display += itemLabel;
          }

          if (Array.isArray(item.dependencies) && item.dependencies.length > 0) {
            display += createHierarchyDisplay(item.dependencies, createLinks);
          }

          display += '</li>';
        });
        display += '</ul>';
        return display;
      }

      return createHierarchyDisplay(hierarchy, createLinks);
    }

    function createPublishedDisplay(publishedId) {
      var display = '<ul>';
      display += '<li><a href="' + orgUrl + 'item.html?id=' + publishedId +
        '" target="_blank">Item</a></li>';
      display += '<li><a href="' + portal + 'sharing/content/items/' + publishedId +
        '?f=json" target="_blank">Item JSON</a></li>';
      display += '<li><a href="' + portal + 'sharing/content/items/' + publishedId +
        '/data?f=json" target="_blank">Data JSON</a></li>';
      display += '</ul>';

      return display;
    }

  });
  </script>
</body>
</html>

