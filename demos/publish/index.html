<!doctype html>
<html lang="en">
<head>
    <meta charset=utf-8>
    <!--
     | Copyright 2018 Esri
     |
     | Licensed under the Apache License, Version 2.0 (the "License");
     | you may not use this file except in compliance with the License.
     | You may obtain a copy of the License at
     |
     |    http://www.apache.org/licenses/LICENSE-2.0
     |
     | Unless required by applicable law or agreed to in writing, software
     | distributed under the License is distributed on an "AS IS" BASIS,
     | WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     | See the License for the specific language governing permissions and
     | limitations under the License.
    -->
  <title>Publish solution template</title>
  <link rel="stylesheet" type="text/css" href="../demo_common/common.css">
</head>
<body>
  <h3>Publish solution template</h3>
  <div id="page" style="display:none">

    <div class="section">
      <div class="section-title">Credentials in publishing organization</div>
      <label for="username">Username:</label> <input type="text" id="username">
      <label for="password">Password:</label> <input type="password" id="password">
    </div>

    <div class="section">
      <div class="section-title">Items to package into a single Solution (along with their dependencies)</div>
      <div id="sourceItemsDiv"></div>
      <br>
      <button id="createBtn" onclick="createSolutionFcn()" disabled="disabled">Create solution</button>
    </div>

    <div id="create" class="section" style="display:none">
      <div class="section-title">Solution ready for publishing</div>
      <img id="creating" src="../demo_common/images/loading.gif"/>
      <div id="createResults" style="display:none">
        <div id="createDisplay"></div>
        <br>
        <label for="username">Name for published Solution</label> <input type="text" id="solutionName"><br>
        <button id="publishBtn" onclick="publishSolutionFcn()">Publish solution</button>
      </div>
    </div>

    <div id="display" class="section" style="display:none">
      <div class="section-title">Published Solution details</div>
      <img id="fetchingDetails" src="../demo_common/images/loading.gif"/>
      <div id="detailsResults" style="display:none">
        <div id="detailsDisplay"></div>
      </div>
    </div>

  </div>

  <script src="../demo_common/require_2.3.6.min.js"></script>
  <script>
  var createSolutionFcn = publishSolutionFcn = null;

  /**
   * Makes the 'Create' button's available if one or more source items are checked.
   */
  function onCheckboxClicked() {
    document.getElementById('createBtn').disabled = getCheckedItems().length === 0 ? 'disabled' : '';
  }

  /**
   * Gets the list of checked source items from the UI.
   */
  function getCheckedItems() {
    var checkedItems = [];
    Array.prototype.slice.call(document.getElementsByTagName('input')).forEach(function (item) {
      if (item.type === 'checkbox' && item.checked) {
        checkedItems.push(item.name);
      }
    });
    return checkedItems;
  }

  requirejs.config({
    baseUrl: './',
    paths: {
      // for the benefit of arcgis-clone-js
      'tslib': '../demo_common/tslib',
      // for the benefit of called libraries that use arcgis-rest-auth
      '@esri/arcgis-rest-auth': 'https://unpkg.com/@esri/arcgis-rest-auth@1.14.3/dist/umd/auth.umd',
      '@esri/arcgis-rest-feature-service-admin':
        'https://unpkg.com/@esri/arcgis-rest-feature-service-admin@1.14.3/dist/umd/feature-service-admin.umd',
      '@esri/arcgis-rest-groups': 'https://unpkg.com/@esri/arcgis-rest-groups@1.14.3/dist/umd/groups.umd',
      '@esri/arcgis-rest-items': 'https://unpkg.com/@esri/arcgis-rest-items@1.14.3/dist/umd/items.umd',
      '@esri/arcgis-rest-request': 'https://unpkg.com/@esri/arcgis-rest-request@1.14.3/dist/umd/request.umd',
      '@esri/arcgis-rest-sharing': 'https://unpkg.com/@esri/arcgis-rest-sharing@1.14.3/dist/umd/sharing.umd'
    }
  });
  requirejs([
    '../../dist/tsumd/src/index',
    '../demo_common/common',
    '@esri/arcgis-rest-auth',
    '@esri/arcgis-rest-items',
    '@esri/arcgis-rest-request'
  ], function (
    clone,
    demoCommon,
    auth,
    items,
    request
  ) {
    createSolutionFcn = createSolution;
    publishSolutionFcn = publishSolution;
    var requestOptions, orgUrl, portalUrl, solution;

    // Add sample items to display
    var sourceItemsDiv = document.getElementById('sourceItemsDiv');
    var sampleItems = [
      ["ArcGIS Pro Add In", "Coordinate Conversion", "eb9c2241d0a94e198635b220307abd0f"],
      ["Code Attachment", "", ""],  //???
      ["Code Sample", "src zip", "9461d58bf12048469e7bc5bc0cbc8265"],
      ["Code Sample", "zip", "e25678986d7d4a828c300e3e834e4fcf"],
      ["CSV", "csv", "0fa88a9ff71e4ab0bd5c3be8b2c84ab2"],
      ["Dashboard", "ROW Permit Dashboard", "9bccd0fac5f3422c948e15c101c26934"],
      ["Desktop Add In", "Python Add-In Wizard", "5f3aefe77f6b4f61ad3e4c62f30bff3b"],
      ["Desktop Application Template", "Address Data Management", "11a6b8b5362143ce86d0ae71441f03b6"],
      ["Document Link", "Master Thoroughfare Plan June 2009", "7d646b2eacd8404781790ad6c763fc41"],
      ["Document Link", "Solution Deployment Tool for ArcGIS Pro", "d159b242e42243a0a110e25703de9c32"],
      ["Feature Collection", "", ""],  //???
      ["Feature Service", "ROWPermits_dashboard", "ba18dc5e55d14f5a9a9d2a5c411225a9"],
      ["Form", "Homeless Count", "873994be893f47a4bf01d3e6c245b5cd"],
      ["Geoprocessing Package", "UploadExample", "d31cc0d3bfbd4e7ba14dc4c6e5a8bb77"],
      ["Geoprocessing Sample", "3D Sample Tools", "fe221371b77940749ff96e90f2de3d10"],
      ["Image", "Climbing A Mountain", "435b1a7cb3a04885afba40c07a4f2fdf"],
      ["Image", "jpeg", "4eeb0354522d49228c677458c09508ff"],
      ["Image", "png", "ce38947c851c4f80803b97711216a01c"],
      ["Image", "tiff", "ab6347ddb9b040a98db42798ff9e3233"],
      ["Layer Package", "Gemeentegrenzen 2014", "218ecc03273d4de184d99be8f22cc0a7"],
      ["Map Template", "PollMap Application Sample Template for ArcGIS 10", "cbd7cc140f354bcf8343e549cdc97902"],
      ["Microsoft Excel", "xlsx", "2bed2d3bbc8744168c40ff71305997cb"],
      ["Microsoft Powerpoint", "pptx", "1ab1ef7e1cb14a27a340c328dad942ca"],
      ["Microsoft Word", "word", "bcd111a69ee84468b21295b1448ff2e5"],
      ["Operation View", "Photo Survey Dashboard", "87b58050d9514e0e8a00d1611048f8d3"],
      ["PDF", "pdf", "8a399c5a087441b89573a7fad905998a"],
      ["Pro Map", "Heavy_Rail_Expansion", "ef249342c29c461096fcc68dfc64ee31"],
      ["Project Package", "Lake Poyang Project", "dee08e6b6969406bb9696a3f370e03d3"],
      ["Project Template", "MaritimeS101_Project2_2", "d40f64bcb9114a9ba6a67156ea522993"],
      ["Service Definition", "PointFilterableComments", "3ee671cf05594744864afe6c368d4a1a"],
      ["Web Map", "Railroads", "3f789c81207b48bdb7dd80e3403dde96"],
      ["Web Map", "ROW Permit Public Comment", "164831217e154849a731573e1855cb1a"],
      ["Web Map", "webmap", "b1c3fd3061de44afbaffd6241ddc8766", "6fc5992522d34f26b2210d17835eea21"],
      ["Web Mapping Application", "ROW Permit Manager", "8974dec44d794311a69f5562659587e6"],
      ["Web Mapping Application", "ROW Permit Public Comment", "6fc5992522d34f26b2210d17835eea21"],
      ["Web Mapping Application", "webapp", "d7746f71b56f4937a72df1026964aba8"],
      ["Workforce Project", "BOE Technical Support", "fb04d6dbc9e046cba1f39b3cf10c6e85"]
    ];
    sampleItems.forEach(function (sample) {
      var agolType = sample[0];
      var title = sample[1];
      var agolId = sample[2];
      if (agolId) {
        sourceItemsDiv.innerHTML +=
          '<input type="checkbox" onclick="onCheckboxClicked()" name="' + agolId +
          '"><label for="' + agolId + ' ">' + agolType + ' "' + title + '"</label><br>';
      }
    });


    document.getElementById('page').style.display = 'block';

    //----------------------------------------------------------------------------------------------------------------//

    /**
     * Creates a solution from a set of existing AGOL items
     */
    function createSolution() {
      document.getElementById('createBtn').disabled = 'disabled';
      document.getElementById('create').style.display = 'block';

      // Prepare credentials for library
      requestOptions = demoCommon.getRequestOptions('username', 'password');

      // Get the publisher's organization URL for creating links to source items
      request.getPortal(null, requestOptions)
      .then(
        function (response) {
          orgUrl = 'https://' + response.urlKey + '.' + response.customBaseUrl + '/home/';
          portalUrl = 'https://' + response.portalHostname + '/';

          // Get the items to include in the solution, then generate the solution
          var solutionRootIds = getCheckedItems();

          // Get the items forming the solution
          clone.createSolution(solutionRootIds, requestOptions)
          .then(
            createdSolution => {
              solution = createdSolution;

              // Display the Solution
              document.getElementById('createDisplay').innerHTML = 'Source hierarchy:' +
                demoCommon.createHierarchyDisplay(solution, clone.getItemHierarchy(solution), true, orgUrl);
            },
            error => {
             document.getElementById('createDisplay').innerHTML = error.toString();
            }
          )
          .finally(
            () => {
              document.getElementById('creating').style.display = 'none';
              document.getElementById('createResults').style.display = 'block';
            }
          );

        },
        function () {
          document.getElementById('create').style.display = 'none';
          alert('Please refresh page and provide credentials');
        }
      );
    }

    /**
     * Creates a solution item in the user's organization.
     */
    function publishSolution() {
      document.getElementById('publishBtn').disabled = 'disabled';
      document.getElementById('display').style.display = 'block';

      // Publish the Solution
      var solutionName = document.getElementById('solutionName').value || 'Solution';
      clone.publishSolution(solutionName, solution, requestOptions, null, 'public')
      .then(function (publishResponse) {
        var publishedSolutionId = publishResponse.id;

        items.getItemData(publishedSolutionId, requestOptions)
        .then(
          publishedSolution => {
            document.getElementById('detailsDisplay').innerHTML =
              demoCommon.createItemLinksDisplay(publishedSolutionId, orgUrl, portalUrl) +
              '<br>Published Solution item hierarchy:' +
              demoCommon.createHierarchyDisplay(publishedSolution.items,
                clone.getItemHierarchy(publishedSolution.items));
          }
        );
      }, function (error) {
         document.getElementById('detailsDisplay').innerHTML = error.toString();
      })
      .finally(() => {
        document.getElementById('fetchingDetails').style.display = 'none';
        document.getElementById('detailsResults').style.display = 'block';
      });
    }

    //----------------------------------------------------------------------------------------------------------------//

  });
  </script>
</body>
</html>
