/* @preserve
* arcgis-clone-js - v0.4.0 - Apache-2.0
* Copyright (c) 2018-2019 Esri, Inc.
* Mon Feb 25 2019 14:27:51 GMT-0700 (Mountain Standard Time)
*/
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(e.arcgisClone=e.arcgisClone||{})}(this,function(e){"use strict";const r=(e,r,t)=>r.split(".").reduce((e,r)=>e?e[r]:t,e);function t(e,r){return Object.keys(e).reduce(function(t,n){return t[n]=r(e[n],n,e),t},{})}const n=e=>e instanceof Date,o=e=>"function"==typeof e,i=e=>"object"==typeof e,s=e=>e instanceof RegExp;const a=e=>"object"==typeof e;function u(e,r){if(r=r||"",Array.isArray(e)){return function(e){let r=e,t=e.reduce((e,r)=>{if(d(r)&&f(r)){let t=c(r);t>e&&(e=t)}return e},-1);t>-1&&(r=0===t?[]:`{{delete:${t-1}}}`);return r}(e.map(n).filter(e=>null!==e&&void 0!==e))}return e&&a(e)?function(e){let r,t=Object.keys(e).reduce((r,t)=>{let n=e[t];if(d(n)&&f(n)){let e=c(n);e>r.maxLevel&&(r.maxLevel=e)}else r.obj[t]=n;return r},{obj:{},maxLevel:-1});r=t.maxLevel>0?1===t.maxLevel?void 0:`{{delete:${t.maxLevel-1}}}`:t.obj;return r}(t(e,n)):function(e){let r=e;"string"==typeof e&&f(e)&&(r=function(e){let r=e,t=c(e);r=0===t?void 0:`{{delete:${t}}}`;return r}(e));return r}(e);function n(e,t){return u(e,r?r+"."+t:t)}}const c=e=>parseInt(e.replace(/{|}/g,"").split(":")[1]);function f(e){return!(!e||"string"!=typeof e)&&e.indexOf("{{delete")>-1}const d=e=>"string"==typeof e;function m(e,r,t,n=0){let o=r;return r||(o=`{{delete:${n}}}`),o}const l=/{{\s*?[\w].*?}}/g,p=e=>"string"==typeof e;function h(e,a,c=null){if((c=c||{}).optional)throw new Error("Please do not pass in an `optional` transform; adlib provides that internally.");return c.optional=m,u(function e(r,a,u){if(u=u||"",Array.isArray(r))return r.map(c);if(!r||!i(r)||n(r)||s(r)||o(r))return a(r,u);return Object.assign({},r,t(r,c));function c(r,t){return e(r,a,u?u+"."+t:t)}}(e,function(e,t){if(!p(e))return e;var n;let o=e.match(l);if(o&&o.length){let t=!1;return o.map(e=>{let n=e.replace(/{|}/g,"").trim();if(n.indexOf("||")>-1){var o=n.split("||").map(e=>e.trim());let e=o.length;n=o.find((n,o)=>{return function(e,t){let n=e.split(":")[0],o=r(t,n,null);return null!==o&&void 0!==o}(n,a)?n:o+1===e&&(t=!0,isNaN(n)||(n=parseInt(n)),n)})}let i={key:e,value:n};return t||(i.value=function(e,t,n){let o,i=e.split(":");if(i.length>1){let s=i[0],a=i[1],u=null;if(i[2]&&(u=i[2]),!n||!n[a]||"function"!=typeof n[a])throw new Error(`Attempted to apply non-existant transform ${a} on ${s} with params ${e}`);o=r(t,s),o=n[a](s,o,t,u)}else o=r(t,e);return o}(n,a,c)||e),i}).forEach(r=>{e===r.key?("string"==typeof r.value&&(isNaN(r.value)||(r.value.indexOf(".")>-1?r.value=parseFloat(r.value):r.value=parseInt(r.value))),n=r.value):e=e.replace(r.key,r.value)}),n||e}return e}))}var y=function(e,r){return(y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};var v=function(){return(v=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};function g(e){return Object.keys(e).some(function(r){var t=e[r];if(!t)return!1;switch(t.constructor.name){case"Array":case"Object":case"Date":case"Function":case"Boolean":case"String":case"Number":return!1;default:return!0}})}function I(e){var r={};return Object.keys(e).forEach(function(t){var n=e[t];if(n||0===n||"boolean"==typeof n||"string"==typeof n){var o;switch(n.constructor.name){case"Array":o=n[0]&&n[0].constructor&&"Object"===n[0].constructor.name?JSON.stringify(n):n.join(",");break;case"Object":o=JSON.stringify(n);break;case"Date":o=n.valueOf();break;case"Function":o=null;break;case"Boolean":o=n+"";break;default:o=n}(o||0===o||"string"==typeof o)&&(r[t]=o)}}),r}function w(e){var r=I(e);return Object.keys(r).map(function(e){return function(e,r){return encodeURIComponent(e)+"="+encodeURIComponent(r)}(e,r[e])}).join("&")}var b=function(){return function(e,r,t,n,o){e=e||"UNKNOWN_ERROR",r=r||"UNKNOWN_ERROR_CODE",this.name="ArcGISRequestError",this.message="UNKNOWN_ERROR_CODE"===r?e:r+": "+e,this.originalMessage=e,this.code=r,this.response=t,this.url=n,this.options=o}}();b.prototype=Object.create(Error.prototype),b.prototype.constructor=b;var O="@esri/arcgis-rest-js";function T(e,r){void 0===r&&(r={params:{f:"json"}});var t=v({httpMethod:"POST"},r),n=[],o=[];if(t.fetch||"undefined"==typeof fetch?(n.push("`fetch`"),o.push("`isomorphic-fetch`")):t.fetch=fetch.bind(Function("return this")()),"undefined"==typeof Promise&&(n.push("`Promise`"),o.push("`es6-promise`")),"undefined"==typeof FormData&&(n.push("`FormData`"),o.push("`isomorphic-form-data`")),!t.fetch||"undefined"==typeof Promise||"undefined"==typeof FormData)throw new Error("`arcgis-rest-request` requires global variables for `fetch`, `Promise` and `FormData` to be present in the global scope. You are missing "+n.join(", ")+". We recommend installing the "+o.join(", ")+" modules at the root of your application to add these to the global scope. See https://bit.ly/2KNwWaJ for more info.");var i=t.httpMethod,s=t.authentication,a=v({f:"json"},r.params),u={method:i,credentials:"same-origin"};return(s?s.getToken(e,{fetch:t.fetch}):Promise.resolve("")).then(function(n){if(n.length&&(a.token=n),"GET"===u.method){var o=""===w(a)?e:e+"?"+w(a);t.maxUrlLength&&o.length>t.maxUrlLength?u.method="POST":e=o}return"POST"===u.method&&(u.body=function(e){var r=g(e),t=I(e);if(r){var n=new FormData;return Object.keys(t).forEach(function(e){if("undefined"!=typeof Blob&&t[e]instanceof Blob){var r=t.fileName||t[e].name||e;n.append(e,t[e],r)}else n.append(e,t[e])}),n}return w(e)}(a)),u.headers=v({},r.headers),"undefined"!=typeof window||u.headers.referer||(u.headers.referer=O),g(a)||(u.headers["Content-Type"]="application/x-www-form-urlencoded"),t.fetch(e,u)}).then(function(r){if(!r.ok){var n=r.status,o=r.statusText;throw new b(o,"HTTP "+n,r,e,t)}switch(a.f){case"json":case"geojson":return r.json();case"html":case"text":return r.text();default:return r.blob()}}).then(function(r){return"json"===a.f||"geojson"===a.f?function(e,r,t,n){if(e.code>=400){var o=e.message,i=e.code;throw new b(o,i,e,r,n)}if(e.error){var s=e.error,o=s.message,i=s.code,a=s.messageCode,u=a||i||"UNKNOWN_ERROR_CODE";if(498===i||499===i||"GWM_0003"===a)throw new P(o,u,e,r,n);throw new b(o,u,e,r,n)}if("failed"===e.status||"failure"===e.status){var o=void 0,i="UNKNOWN_ERROR_CODE";try{o=JSON.parse(e.statusMessage).message,i=JSON.parse(e.statusMessage).code}catch(r){o=e.statusMessage||e.message}throw new b(o,i,e,r,n)}return e}(r,e,0,t):r})}var E,P=function(e){function r(r,t,n,o,i){void 0===r&&(r="AUTHENTICATION_ERROR"),void 0===t&&(t="AUTHENTICATION_ERROR_CODE");var s=e.call(this,r,t,n,o,i)||this;return s.name="ArcGISAuthError",s.message="AUTHENTICATION_ERROR_CODE"===t?r:t+": "+r,s}return function(e,r){function t(){this.constructor=e}y(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}(r,e),r.prototype.retry=function(e,r){var t=this;void 0===r&&(r=3);var n=0,o=function(i,s){e(t.url,t.options).then(function(e){var r=v({},t.options,{authentication:e});return n+=1,T(t.url,r)}).then(function(e){i(e)}).catch(function(e){"ArcGISAuthError"===e.name&&n<r?o(i,s):"ArcGISAuthError"===e.name&&n>=r?s(t):s(e)})};return new Promise(function(e,r){o(e,r)})},r}(b);function A(e){return"/"===(e=e.trim())[e.length-1]&&(e=e.slice(0,-1)),e}function k(e){return void 0===e&&(e={}),e.portal?A(e.portal):e.authentication?e.authentication.portal:"https://www.arcgis.com/sharing/rest"}function S(e){var r=JSON.parse(JSON.stringify(e)),t=e.typeKeywords,n=void 0===t?[]:t,o=e.tags,i=void 0===o?[]:o;return r.typeKeywords=n.join(", "),r.tags=i.join(", "),r.data&&(r.text=JSON.stringify(r.data),delete r.data),r.properties&&(r.properties=JSON.stringify(r.properties)),r}function x(e){return e.owner?e.owner:e.item&&e.item.owner?e.item.owner:e.authentication.username}function j(e){var r=x(e),t=k(e)+"/content/users/"+r,n=t+"/addItem";return e.folder&&(n=t+"/"+e.folder+"/addItem"),e.params=v({},e.params,S(e.item)),T(n,e)}function D(e){var r=x(e),t=k(e)+"/content/users/"+r+"/items/"+e.item.id+"/update";return e.params=v({},e.params,S(e.item)),T(t,e)}function R(e){var r,t,n,o,i=k(e)+"/community/createGroup",s=v({},e);return s.params=(r=e.group,t=JSON.parse(JSON.stringify(r)),n=r.tags,o=void 0===n?[]:n,t.tags=o.join(", "),t),T(i,s)}function N(e,r){return T(k(r)+"/community/groups/"+e,v({httpMethod:"GET"},r))}function C(e){return e.authentication.getUser(e).then(function(e){return!(!e||"org_admin"!==e.role)})}function _(e){var r=function(e){var r=e.authentication.username,t=e.owner||r;return k(e)+"/content/users/"+encodeURIComponent(t)+"/items/"+e.id+"/share"}(e);return function(e){var r=e.authentication.username;return(e.owner||r)===r}(e)?F(r,e):C(e).then(function(t){if(t)return F(r,e);throw Error("This item can not be shared by "+e.authentication.username+". They are neither the item owner nor an organization admin.")})}function F(e,r){return r.params=v({org:!1,everyone:!1},r.params),"private"===r.access&&(r.params.groups=" "),"org"===r.access&&(r.params.org=!0),"public"===r.access&&(r.params.org=!0,r.params.everyone=!0),T(e,r)}function L(e){return function(e){var r=e.authentication.username,t=e.owner||r;return C(e).then(function(n){var o="share"===e.action?"notSharedWith":"notUnsharedFrom";return function(e){var r={q:"id: "+e.id+" AND group: "+e.groupId,start:1,num:10,sortField:"title"},t=v({},e);return t.params=v({},r,e.params),T(k(t)+"/search",t).then(function(r){return 0!==r.total&&(r.results.some(function(r){var n=r.id===e.id;return n&&(t=r),n}),!!t);var t})}(e).then(function(i){if("share"===e.action&&!0===i||"unshare"===e.action&&!1===i){var s={itemId:e.id,shortcut:!0};return s[o]=[],s}return function(e){return N(e.groupId,e).then(function(e){return e.userMembership.memberType}).catch(function(){return"nonmember"})}(e).then(function(o){if("nonmember"===o)throw Error("This item can not be "+e.action+"d by "+r+" as they are not a member of the specified group "+e.groupId+".");if(t===r||n)return k(e)+"/content/users/"+t+"/items/"+e.id+"/"+e.action;if("admin"===o||"owner"===o)return k(e)+"/content/items/"+e.id+"/"+e.action;throw Error("This item can not be "+e.action+"d by "+r+" as they are neither the owner, a groupAdmin of "+e.groupId+", nor an org_admin.")}).then(function(r){return e.params={groups:e.groupId,confirmItemControl:e.confirmItemControl},T(r,e)}).then(function(r){if(r[o].length)throw Error("Item "+e.id+" could not be "+e.action+"d to group "+e.groupId+".");return r})})})}(v({action:"share"},e))}!function(e){e.ArcGISRequestError="ArcGISRequestError",e.ArcGISAuthError="ArcGISAuthError"}(E||(E={}));var U="{{organization.portalBaseUrl}}";function W(e){e.item.extent&&(e.item.extent="{{initiative.extent:optional}}"),e.item.id=J(e.item.id)}function G(e,r,t,n,o){return void 0===n&&(n=null),void 0===o&&(o="private"),new Promise(function(i,s){var a=v({item:e,folder:n},t);r&&(a.item.text=r),j(a).then(function(r){(delete e.text,"private"!==o)?_(v({id:r.id,access:o},t)).then(function(e){i({success:!0,id:e.itemId})},function(e){return s({success:!1,error:e.error?e.error:e})}):i({success:!0,id:r.id})},function(e){return s({success:!1,error:e.error?e.error:e})})})}function M(e){return Array.isArray(e)?e.map(function(e){return M(e)}):e&&e.startsWith("{{")?e.substring(2,e.indexOf(".")):e}function B(e,r,t){t&&t({processId:e,status:r?"done":"failed"})}function z(){var e=new Date;return K(e.getUTCFullYear(),4)+K(e.getUTCMonth()+1,2)+K(e.getUTCDate(),2)+"_"+K(e.getUTCHours(),2)+K(e.getUTCMinutes(),2)+"_"+K(e.getUTCSeconds(),2)+K(e.getUTCMilliseconds(),3)}function K(e,r){var t=e.toString(),n=r-t.length;return n>0&&(t="0".repeat(n)+t),t}function J(e,r){return void 0===r&&(r="id"),Array.isArray(e)?function(e,r){void 0===r&&(r="id");return e.map(function(e){return J(e,r)})}(e,r):e&&e.startsWith("{{")?e:"{{"+e+"."+r+"}}"}function H(e,r,t){return new Promise(function(n,o){D(v({item:{id:e,url:r}},t)).then(function(r){n(e)},function(e){return o({error:e.error?e.error:e})})})}function $(e,r){return r.split(".").reduce(function(e,r){return e?e[r]:void 0},e)}function q(e,r){return r.reduce(function(r,t){var n=$(e,t);return n&&r.push(n),r},[])}function V(e,r){var t,n=[];if(!e)return n;for(t in e)e.hasOwnProperty(t)&&(t===r?n.push(e[t]):Array.isArray(e[t])?e[t].forEach(function(e){n=n.concat(V(e,r))}):"object"==typeof e[t]&&(n=n.concat(V(e[t],r))));return n}function Y(e,r){return($(e,"item.typeKeywords")||e.typeKeywords||[]).includes(r)}function Q(e){return void 0===e&&(e="i"),""+e+Math.random().toString(36).substr(2,8)}var X="/apps/opsdashboard/index.html#/";function Z(e){var r=[],t=$(e,"data.widgets");return t&&t.forEach(function(e){"mapWidget"===e.type&&r.push(e.itemId)}),r}var ee=Object.freeze({OPS_DASHBOARD_APP_URL_PART:X,convertItemToTemplate:function(e,r){return new Promise(function(r){e.estimatedDeploymentCostFactor=4,W(e),e.item.url=U+X,e.dependencies=Z(e),r(e)})},createItemFromTemplate:function(e,r,t,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var s=v({item:e.item,folder:r.folderId},t);e.data&&(s.item.text=e.data),n&&n({processId:e.key,status:"creating"}),j(s).then(function(s){s.success?(r[e.itemId]={id:s.id},e.itemId=e.item.id=s.id,e=h(e,r),n&&n({processId:e.key,status:"updating URL"}),H(e.itemId,e.item.url,t).then(function(){B(e.key,!0,n),o(e)},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})):(B(e.key,!1,n),i({success:!1}))},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})})},extractDependencies:Z});function re(e,r,t){return new Promise(function(n,o){if(e.dependencies.length>0){var i=[];e.dependencies.forEach(function(n){i.push(new Promise(function(o,i){L(v({id:n,groupId:e.itemId},r)).then(function(){t&&t({processId:e.key,status:"added group member"}),o()},function(r){B(e.key,!1,t),i({success:!1,error:r.error?r.error:r})})}))}),Promise.all(i).then(function(){return n()},function(e){return o({success:!1,error:e.error?e.error:e})})}else n()})}function te(e,r){return new Promise(function(t,n){var o=v({paging:{start:1,num:100}},r);ne(e.itemId,o).then(function(r){e.estimatedDeploymentCostFactor=3+r.length,t(r)},function(e){return n({success:!1,error:e.error?e.error:e})})})}function ne(e,r){return new Promise(function(t,n){(function(e,r){var t=k(r)+"/content/groups/"+e,n=v({httpMethod:"GET"},{params:{start:1,num:100}},r);return r&&r.paging&&(n.params=v({},r.paging)),T(t,n)})(e,r).then(function(o){if(o.num>0){var i=o.items.map(function(e){return e.id});o.nextStart>0?(r.paging.start=o.nextStart,ne(e,r).then(function(e){t(i.concat(e))},function(e){return n({success:!1,error:e.error?e.error:e})})):t(i)}else t([])},function(e){return n({success:!1,error:e.error?e.error:e})})})}var oe=Object.freeze({convertItemToTemplate:function(e,r){return new Promise(function(t,n){e.estimatedDeploymentCostFactor=3,W(e),te(e,r).then(function(r){e.dependencies=r,t(e)},function(e){return n({success:!1,error:e.error?e.error:e})})})},createItemFromTemplate:function(e,r,t,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var s=v({group:e.item},t);s.group.title+="_"+z(),n&&n({processId:e.key,status:"creating"}),R(s).then(function(s){s.success?(r[e.itemId]={id:s.group.id},e.itemId=s.group.id,re(e=h(e,r),t,n).then(function(){B(e.key,!0,n),o(e)},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})):(B(e.key,!1,n),i({success:!1}))},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})})},addGroupMembers:re,getGroupContents:te,getGroupContentsTranche:ne});function ie(e){var r=x(e),t=k(e)+"/content/users/"+r+"/createService";return e.params=v({createParameters:e.item,outputType:"featureService"},e.params),e.folderId&&"/"!==e.folderId?T(t,e).then(function(r){if(r.success)return function(e){var r=x(e),t=k(e)+"/content/users/"+r+"/items/"+e.itemId+"/move",n=e.folderId;return n||(n="/"),e.params=v({folder:n},e.params),T(t,e)}({itemId:r.itemId,folderId:e.folderId,authentication:e.authentication}).then(function(e){if(e.success)return r;throw Error("A problem was encountered when trying to move the service to a different folder.")});throw Error("A problem was encountered when trying to create the service.")}):T(t,e)}function se(e,r){var t=A(e).replace("/rest/services","/rest/admin/services")+"/addToDefinition";return r.params=v({addToDefinition:{}},r.params),r.layers&&r.layers.length>0&&(r.params.addToDefinition.layers=r.layers),r.tables&&r.tables.length>0&&(r.params.addToDefinition.tables=r.tables),T(t,r)}function ae(e,r){var t=[];return new Promise(function(n,o){var i=e.item.url;e.item.url=J(e.itemId,"url"),e.properties.service.isView?T(i+"/sources?f=json",r).then(function(e){e&&e.services&&(e.services.forEach(function(e){t.push(e.serviceItemId)}),n(t))},function(e){return o({success:!1,error:e.error?e.error:e})}):n(t)})}function ue(e,r,t,n){return new Promise(function(o,i){var s=e.properties,a=[];(s.layers||[]).forEach(function(e){a[e.id]={item:e,type:"layer"}}),(s.tables||[]).forEach(function(e){a[e.id]={item:e,type:"table"}});var u={};a.length>0?function e(r,t,n,o,i,s,a,u){return new Promise(function(c,f){if(n.length>0){var d=n.shift(),m=d.item,l=m.id;delete m.serviceItemId,Array.isArray(m.relationships)&&m.relationships.length>0&&(i[l]=m.relationships,m.relationships=[]);var p=v({},s);"layer"===d.type?p.layers=[m]:p.tables=[m],se(t,p).then(function(){u&&u({processId:a,status:"added layer"}),e(r,t,n,o,i,s,a,u).then(function(){return c()},function(e){return f({success:!1,error:e.error?e.error:e})})},function(e){return f({success:!1,error:e.error?e.error:e})})}else c()})}(e.itemId,e.item.url,a,r,u,t,e.key,n).then(function(){var r=[];Object.keys(u).forEach(function(o){r.push(new Promise(function(r,i){var s=v({params:{updateFeatureServiceDefinition:{relationships:u[o]}}},t);se(e.item.url+"/"+o,s).then(function(){n&&n({processId:e.key,status:"updated relationship"}),r()},function(e){return i(e)})}))}),Promise.all(r).then(function(){return o()},function(e){return i({success:!1,error:e.error?e.error:e})})},function(e){return i({success:!1,error:e.error?e.error:e})}):o()})}function ce(e){return e.reduce(function(e,r){return e+(r.relationships?r.relationships.length:0)},0)}function fe(e,r){return new Promise(function(t,n){T(e.item.url.replace("/rest/services","/rest/admin/services")+"?f=json",r).then(function(e){t({adminLayers:e.layers,adminTables:e.tables})},function(e){return n({success:!1,error:e.error?e.error:e})}).catch(function(e){return n({success:!1,error:e.error?e.error:e})})})}function de(e,r){return new Promise(function(t,n){var o={service:{},layers:[],tables:[]},i=e.item.url;T(i+"?f=json",r).then(function(s){s.serviceItemId=J(s.serviceItemId),o.service=s,fe(e,r).then(function(a){Promise.all([pe(i,s.layers,a.adminLayers,r),pe(i,s.tables,a.adminTables,r)]).then(function(r){o.layers=r[0],o.tables=r[1],e.properties=o,e.estimatedDeploymentCostFactor+=o.layers.length+ce(o.layers)+o.tables.length+ce(o.tables),t()},function(e){return n({success:!1,error:e.error?e.error:e})})},function(e){return n({success:!1,error:e.error?e.error:e})})},function(e){return n({success:!1,error:e.error?e.error:e})})})}function me(e,r){var t;if(e.hasOwnProperty(r)&&(le(t=Object.assign({},e[r].adminLayerInfo),"xssTrustedFields"),le(t,"tableName"),t.viewLayerDefinition)){var n=t.viewLayerDefinition;le(n,"sourceId"),n.table&&le(n.table,"sourceId"),n.sourceServiceName=J(String(n.sourceServiceName),"adminLayerInfo.viewLayerDefinition.sourceServiceName")}return t}function le(e,r){e&&e.hasOwnProperty(r)&&delete e[r]}function pe(e,r,t,n){return new Promise(function(o,i){Array.isArray(r)&&0!==r.length||o([]);var s=[];r.forEach(function(r){s.push(T(e+"/"+r.id+"?f=json",n))}),Promise.all(s).then(function(e){e.forEach(function(e){e.editFieldsInfo=null,e.serviceItemId=J(e.serviceItemId),t&&t.indexOf(e.id)>-1&&(e.adminLayerInfo=me(t,e.id))}),o(e)},function(e){return i({success:!1,error:e.error?e.error:e})})})}var he=Object.freeze({convertItemToTemplate:function(e,r){return new Promise(function(t,n){e.estimatedDeploymentCostFactor=3,W(e),de(e,r).then(function(){ae(e,r).then(function(r){e.dependencies=r,t(e)},function(e){return n({success:!1,error:e.error?e.error:e})})},function(e){return n({success:!1,error:e.error?e.error:e})})})},createItemFromTemplate:function(e,r,t,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var s=v({item:e.item,folderId:r.folderId,params:{isView:Boolean(e.properties.service.isView)},preserveLayerIds:!0},t);e.data&&(s.item.text=e.data),s.item.name=e.item.name+"_"+z(),n&&n({processId:e.key,status:"creating"}),ie(s).then(function(s){r[e.itemId]={id:s.serviceItemId,url:s.serviceurl},e.itemId=e.item.id=s.serviceItemId,(e=h(e,r)).item.url=s.serviceurl,D(v({item:{id:e.itemId,title:e.item.title,snippet:e.item.snippet,description:e.item.description,accessInfo:e.item.accessInfo,licenseInfo:e.item.licenseInfo,text:e.data}},t)).then(function(){ue(e,r,t,n).then(function(){B(e.key,!0,n),o(e)},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})})},extractDependencies:ae,addFeatureServiceLayersAndTables:ue,countRelationships:ce,getAdminLayersAndTables:fe,fleshOutFeatureService:de,getAdminLayerInfo:me,getLayers:pe}),ye="/home/webmap/viewer.html?webmap=";function ve(e){var r=[];return e.data&&(r=ge(e.data.operationalLayers).concat(ge(e.data.tables))),r}function ge(e){return void 0===e&&(e=[]),e.reduce(function(e,r){var t=r.itemId;return t&&e.push(t),e},[])}function Ie(e){void 0===e&&(e=[]),e.filter(function(e){return!!e.itemId}).forEach(function(e){var r=e.url.substr(e.url.lastIndexOf("/"));e.itemId=J(e.itemId),e.url=J(M(e.itemId),"url")+r})}var we=Object.freeze({convertItemToTemplate:function(e,r){return new Promise(function(r){e.estimatedDeploymentCostFactor=4,W(e),e.item.url=U+ye+J(e.itemId),e.dependencies=ve(e),e.data&&(Ie(e.data.operationalLayers),Ie(e.data.tables)),r(e)})},createItemFromTemplate:function(e,r,t,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var s=v({item:e.item,folder:r.folderId},t);e.data&&(s.item.text=e.data),n&&n({processId:e.key,status:"creating"}),j(s).then(function(s){s.success?(r[e.itemId]={id:s.id},e.itemId=e.item.id=s.id,e=h(e,r),n&&n({processId:e.key,status:"updating URL"}),H(e.itemId,e.item.url,t).then(function(){B(e.key,!0,n),o(e)},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})):(B(e.key,!1,n),i({success:!1}))},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})})},extractDependencies:ve,getWebmapLayerIds:ge,templatizeWebmapLayerIdsAndUrls:Ie});function be(e){var r=function(e){return[]};return Y(e,"Cascade")&&(r=Oe),Y(e,"MapJournal")&&(r=Ee),Y(e,"mapseries")&&(r=Te),r(e)}function Oe(e){return($(e,"data.values.sections")||[]).reduce(function(e,r){return e.concat(V(r,"webmap").map(function(e){return e.id}))},[])}function Te(e){var r=q(e,["data.values.webmap"]);return($(e,"data.values.story.entries")||[]).forEach(function(e){V(e,"webmap").map(function(e){return e.id}).forEach(function(e){-1===r.indexOf(e)&&r.push(e)})}),r}function Ee(e){return($(e,"data.values.story.sections")||[]).reduce(function(e,r){if(r.media){if("webmap"===r.media.type){var t=$(r,"media.webmap.id");t&&e.push(t)}if("webpage"===r.media.type){var n=function(e){var r=null;if(!e)return r;var t=e.split("?")[1];return t&&(r=t.split("&").reduce(function(e,r){var t,n=r.split("=")[1];return n&&"string"==typeof(t=n)&&("{"===t[0]&&(t=t.substring(1,t.length-1)),/^(\{){0,1}[0-9a-fA-F]{8}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{12}(\}){0,1}$/gi.test(t))&&(e=n),e},null)),r}($(r,"media.webpage.url"));n&&e.push(n)}}return e},[])}function Pe(e){var r=[],t=$(e,"data.map.itemId");return t&&r.push(t),r}function Ae(e){var r=ke;return Y(e,"Story Map")&&(r=be),function(e,r){var t=$(e,"item.typeKeywords")||e.typeKeywords||[];return r.reduce(function(e,r){return e||(e=t.includes(r)),e},!1)}(e,["WAB2D","WAB3D","Web AppBuilder"])&&(r=Pe),r(e)}function ke(e){return q(e,["data.webmap","data.itemId","data.values.webmap","data.values.group"])}var Se=Object.freeze({convertItemToTemplate:function(e,r){return new Promise(function(r){e.estimatedDeploymentCostFactor=4,W(e);var t=e.item.url,n=t.indexOf("//");e.item.url=U+t.substring(t.indexOf("/",n+2),t.lastIndexOf("=")+1)+J(e.itemId),$(e,"data.folderId")&&(e.data.folderId="{{folderId}}"),e.dependencies=Ae(e),$(e,"data.values.webmap")?e.data.values.webmap=J(e.data.values.webmap):$(e,"data.values.group")&&(e.data.values.group=J(e.data.values.group)),r(e)})},createItemFromTemplate:function(e,r,t,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var s=v({item:e.item,folder:r.folderId},t);e.data&&(s.item.text=e.data),n&&n({processId:e.key,status:"creating"}),j(s).then(function(s){s.success?(r[e.itemId]={id:s.id},e.itemId=e.item.id=s.id,e=h(e,r),n&&n({processId:e.key,status:"updating URL"}),H(e.itemId,e.item.url,t).then(function(){B(e.key,!0,n),o(e)},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})):(B(e.key,!1,n),i({success:!1}))},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})})},extractDependencies:Ae,getGenericWebAppDependencies:ke});var xe=Object.freeze({convertItemToTemplate:function(e,r){return new Promise(function(r){W(e),r(e)})},createItemFromTemplate:function(e,r,t,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var s=v({item:e.item,folder:r.folderId},t);e.data&&(s.item.text=e.data),n&&n({processId:e.key,status:"creating"}),j(s).then(function(t){t.success?(r[e.itemId]={id:t.id},e.itemId=e.item.id=t.id,B((e=h(e,r)).key,!0,n),o(e)):(B(e.key,!1,n),i({success:!1}))},function(r){B(e.key,!1,n),i({success:!1,error:r.error?r.error:r})})})}}),je={dashboard:ee,"feature service":he,group:oe,"web map":we,"web mapping application":Se};function De(e,r){return new Promise(function(t,n){var o;(function(e,r){return T(k(r)+"/content/items/"+e,v({httpMethod:"GET"},r))})(e,r).then(function(i){je[i.type.toLowerCase()]||console.warn("Unimplemented item type "+i.type+" for "+e),(o={itemId:i.id,type:i.type,key:Q(),item:Ne(i),dependencies:[],fcns:je[i.type.toLowerCase()]||xe,estimatedDeploymentCostFactor:3}).item.id=J(o.item.id),o.item.item&&(o.item.item=J(o.item.item)),o.item.thumbnail="https://www.arcgis.com/sharing/content/items/"+e+"/info/"+o.item.thumbnail;var s=function(e,r){var t=k(r)+"/content/items/"+e+"/data",n=v({httpMethod:"GET",params:{}},r);return n.file&&(n.params.f=null),T(t,n)}(e,r),a=function(e){var r=k(e)+"/content/items/"+e.id+"/resources";return e.params=v({},e.params,{num:1e3}),T(r,e)}(v({id:e},r));Promise.all([s.catch(function(){return null}),a.catch(function(){return null})]).then(function(e){var i=e[0],s=e[1];o.data=i,o.resources=s&&s.total>0?s.resources:null,o.fcns.convertItemToTemplate(o,r).then(function(e){o.dependencies=Re(function(e){void 0===e&&(e=[]);return e.reduce(function(e,r){return e.concat(r)},[])}(e.dependencies)),t(o)},function(e){return n({success:!1,error:e.error?e.error:e})})})},function(){N(e,r).then(function(i){(o={itemId:i.id,type:"Group",key:Q(),item:Ne(i),dependencies:[],fcns:je.group,estimatedDeploymentCostFactor:3}).item.thumbnail="https://www.arcgis.com/sharing/content/items/"+e+"/info/"+o.item.thumbnail,o.fcns.convertItemToTemplate(o,r).then(function(e){o.dependencies=Re(e.dependencies),t(o)},function(e){return n({success:!1,error:e.error?e.error:e})})},function(e){return n({success:!1,error:e.error?e.error:e})})})})}function Re(e){void 0===e&&(e=[]);var r={};return e.forEach(function(e){return r[e]=!0}),Object.keys(r)}function Ne(e){if(e){var r=v({},e);return delete r.avgRating,delete r.created,delete r.guid,delete r.lastModified,delete r.modified,delete r.numComments,delete r.numRatings,delete r.numViews,delete r.orgId,delete r.owner,delete r.scoreCompleteness,delete r.size,delete r.uploaded,r}return null}var Ce;function _e(e,r,t,n,o){return void 0===n&&(n={}),void 0===o&&(o="private"),new Promise(function(i,s){var a=r.item,u="https://www.arcgis.com/sharing/content/items/"+a.id+"/info/"+a.thumbnail;G({itemType:"text",name:null,title:e,description:a.description,tags:a.tags,snippet:a.snippet,thumbnailurl:u,accessInformation:a.accessInformation,type:"Solution",typeKeywords:["Solution","Deployed"],commentsEnabled:!1},null,t,n.folderId,o).then(function(e){var r=n.organization&&n.organization.orgUrl||"https://www.arcgis.com",t={id:e.id,url:r+"/home/item.html?id="+e.id};i(t)},function(e){return s({success:!1,error:e.error?e.error:e})})})}function Fe(e,r,t,n,o){n[e]={};var i=new Promise(function(i,s){var a=Ge(r,e);a||s({success:!1});var u=[];(a.dependencies||[]).forEach(function(e){return u.push(n[e].def)}),Promise.all(u).then(function(){var a=function(e){return e.fcns=je[e.type.toLowerCase()]||xe,e}(Ge(r,e));a.dependencies=a.dependencies?J(a.dependencies):[],(a=h(a,n)).fcns.createItemFromTemplate(a,n,t,o).then(function(e){return i(e)},function(e){return s({success:!1,error:e.error?e.error:e})})},function(e){return s({success:!1,error:e.error?e.error:e})})});return n[e].def=i,i}function Le(e,r,t,n){return n||(n=[]),new Promise(function(o,i){if("string"==typeof e){var s=e;if(Ge(n,s))o(n);else{var a=De(s,t);n.push({itemId:s,type:"",key:"",item:null}),a.then(function(e){if(Me(n,e.itemId,e),0===e.dependencies.length)o(n);else{var s=[];e.dependencies.forEach(function(e){Ge(n,e)||s.push(Le(e,r,t,n))}),Promise.all(s).then(function(){o(n)},function(e){return i({success:!1,error:e.error?e.error:e})})}},function(e){return i({success:!1,error:e.error?e.error:e})})}}else if(Array.isArray(e)&&e.length>0){var u=[];e.forEach(function(e){u.push(Le(e,r,t,n))}),Promise.all(u).then(function(){o(n)},function(e){return i({success:!1,error:e.error?e.error:e})})}else i({success:!1})})}function Ue(e,r,t,n,o){return void 0===n&&(n={}),void 0===o&&(o="private"),new Promise(function(i,s){var a={item:{itemType:"text",name:null,title:e,type:"Solution",typeKeywords:["Solution","Template"],commentsEnabled:!1},data:{metadata:{version:r},templates:[]}};G(a.item,a.data,t,n.folderId,o).then(function(e){var r=n.organization&&n.organization.orgUrl||"https://www.arcgis.com";a.item.id=e.id,a.item.url=r+"/home/item.html?id="+e.id,i(a)},function(e){return s({success:!1,error:e.error?e.error:e})})})}function We(e,r){var t=r;return e.findIndex(function(e){return t===e.itemId})}function Ge(e,r){var t=We(e,r);return t>=0?e[t]:null}function Me(e,r,t){var n=We(e,r);return n>=0&&(e[n]=t,!0)}function Be(e){var r=[],t={};return e.forEach(function(e){t[e.itemId]=Ce.White}),e.forEach(function(n){t[n.itemId]===Ce.White&&function n(o){t[o]=Ce.Gray;var i=Ge(e,o);var s=i.dependencies||[];s.forEach(function(e){if(t[e]===Ce.White)n(e);else if(t[e]===Ce.Gray)throw Error("Cyclical dependency graph detected")});t[o]=Ce.Black;r.push(o)}(n.itemId)}),r}function ze(e){var r=e.map(function(e){return e.itemId});return e.forEach(function(e){(e.dependencies||[]).forEach(function(e){var t=r.indexOf(e);t>=0&&r.splice(t,1)})}),r}!function(e){e[e.White=0]="White",e[e.Gray=1]="Gray",e[e.Black=2]="Black"}(Ce||(Ce={})),e.createSolutionItem=function(e,r,t,n,o){return new Promise(function(i,s){o||(o=n),Ue(e,r,o,void 0,"public").then(function(e){Le(t,e,n).then(function(r){e.data.templates=r,function(e,r){return new Promise(function(t,n){(function(e,r,t){return new Promise(function(n,o){D(v({item:{id:e,text:r}},t)).then(function(r){n(e)},function(e){return o({error:e.error?e.error:e})})})})(e.item.id,e.data,r).then(function(){return t(e)},function(e){return n({success:!1,error:e.error?e.error:e})})})}(e,o).then(function(e){i(e)},function(e){return s({success:!1,error:e.error?e.error:e})})},function(e){return s({success:!1,error:e.error?e.error:e})})},function(e){return s({success:!1,error:e.error?e.error:e})})})},e.deploySolutionItem=function(e,r,t,n){return void 0===t&&(t={}),new Promise(function(o,i){var s=$(e,"data.templates");t.solutionName=t.solutionName||"Solution",s&&0!==Object.keys(s).length||o([]);var a=Be(s);function u(){_e(t.solutionName,e,r,t,"public").then(function(e){var u;n&&n({processId:e.id,type:"Solution",status:"done"}),u=[],a.forEach(function(e){return u.push(Fe(e,s,r,t,n))}),Promise.all(u).then(function(e){return o(e)},function(e){return i({success:!1,error:e.error?e.error:e})})},function(e){return i({success:!1,error:e.error?e.error:e})})}t.folderId?u():function(e){var r=x(e),t=k(e)+"/content/users/"+r+"/createFolder";return e.params=v({title:e.title},e.params),T(t,e)}({title:t.solutionName+" ("+z()+")",authentication:r.authentication}).then(function(e){t.folderId=e.folder.id,u()},function(e){return i({success:!1,error:e.error?e.error:e})})})},e.getEstimatedDeploymentCost=function(e){return e.reduce(function(e,r){return e+(r.estimatedDeploymentCostFactor?r.estimatedDeploymentCostFactor:3)},0)},e.getSupportedItemTypes=function(){return Object.keys(je)},e.PLACEHOLDER_SERVER_NAME="{{organization.portalBaseUrl}}",e.OPS_DASHBOARD_APP_URL_PART="/apps/opsdashboard/index.html#/",e.WEBMAP_APP_URL_PART="/home/webmap/viewer.html?webmap=",e.createDeployedSolutionAgoItem=_e,e.createItemFromTemplateWhenReady=Fe,e.createItemTemplates=Le,e.createSolutionAgoItem=Ue,e.findTemplateInList=Ge,e.publishSolutionTemplate=function(e,r,t,n,o){return void 0===n&&(n=null),void 0===o&&(o="private"),G({title:e,type:"Solution",itemType:"text",typeKeywords:["Template"],access:o,listed:!1,commentsEnabled:!1},{templates:r},t,n,o)},e.replaceTemplate=Me,e.topologicallySortItems=Be,e.getItemHierarchy=function(e){var r=[];return function r(t,n){t.forEach(function(t){var o={id:t,dependencies:[]},i=Ge(e,t).dependencies;Array.isArray(i)&&i.length>0&&r(i,o.dependencies),n.push(o)})}(ze(e),r),r},e.getTopLevelItemIds=ze,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=arcgis-clone.umd.min.js.map
