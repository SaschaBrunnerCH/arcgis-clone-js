/* @preserve
* arcgis-clone-js - v0.4.0 - Apache-2.0
* Copyright (c) 2018-2019 Esri, Inc.
* Mon Feb 25 2019 10:20:33 GMT-0700 (Mountain Standard Time)
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.arcgisClone=e.arcgisClone||{})}(this,function(e){"use strict";const t=(e,t,r)=>t.split(".").reduce((e,t)=>e?e[t]:r,e);function r(e,t){return Object.keys(e).reduce(function(r,n){return r[n]=t(e[n],n,e),r},{})}const n=e=>e instanceof Date,o=e=>"function"==typeof e,i=e=>"object"==typeof e,a=e=>e instanceof RegExp;const s=e=>"object"==typeof e;function u(e,t){if(t=t||"",Array.isArray(e)){return function(e){let t=e,r=e.reduce((e,t)=>{if(d(t)&&f(t)){let r=c(t);r>e&&(e=r)}return e},-1);r>-1&&(t=0===r?[]:`{{delete:${r-1}}}`);return t}(e.map(n).filter(e=>null!==e&&void 0!==e))}return e&&s(e)?function(e){let t,r=Object.keys(e).reduce((t,r)=>{let n=e[r];if(d(n)&&f(n)){let e=c(n);e>t.maxLevel&&(t.maxLevel=e)}else t.obj[r]=n;return t},{obj:{},maxLevel:-1});t=r.maxLevel>0?1===r.maxLevel?void 0:`{{delete:${r.maxLevel-1}}}`:r.obj;return t}(r(e,n)):function(e){let t=e;"string"==typeof e&&f(e)&&(t=function(e){let t=e,r=c(e);t=0===r?void 0:`{{delete:${r}}}`;return t}(e));return t}(e);function n(e,r){return u(e,t?t+"."+r:r)}}const c=e=>parseInt(e.replace(/{|}/g,"").split(":")[1]);function f(e){return!(!e||"string"!=typeof e)&&e.indexOf("{{delete")>-1}const d=e=>"string"==typeof e;function m(e,t,r,n=0){let o=t;return t||(o=`{{delete:${n}}}`),o}const l=/{{\s*?[\w].*?}}/g,p=e=>"string"==typeof e;function h(e,s,c=null){if((c=c||{}).optional)throw new Error("Please do not pass in an `optional` transform; adlib provides that internally.");return c.optional=m,u(function e(t,s,u){if(u=u||"",Array.isArray(t))return t.map(c);if(!t||!i(t)||n(t)||a(t)||o(t))return s(t,u);return Object.assign({},t,r(t,c));function c(t,r){return e(t,s,u?u+"."+r:r)}}(e,function(e,r){if(!p(e))return e;var n;let o=e.match(l);if(o&&o.length){let r=!1;return o.map(e=>{let n=e.replace(/{|}/g,"").trim();if(n.indexOf("||")>-1){var o=n.split("||").map(e=>e.trim());let e=o.length;n=o.find((n,o)=>{return function(e,r){let n=e.split(":")[0],o=t(r,n,null);return null!==o&&void 0!==o}(n,s)?n:o+1===e&&(r=!0,isNaN(n)||(n=parseInt(n)),n)})}let i={key:e,value:n};return r||(i.value=function(e,r,n){let o,i=e.split(":");if(i.length>1){let a=i[0],s=i[1],u=null;if(i[2]&&(u=i[2]),!n||!n[s]||"function"!=typeof n[s])throw new Error(`Attempted to apply non-existant transform ${s} on ${a} with params ${e}`);o=t(r,a),o=n[s](a,o,r,u)}else o=t(r,e);return o}(n,s,c)||e),i}).forEach(t=>{e===t.key?("string"==typeof t.value&&(isNaN(t.value)||(t.value.indexOf(".")>-1?t.value=parseFloat(t.value):t.value=parseInt(t.value))),n=t.value):e=e.replace(t.key,t.value)}),n||e}return e}))}var y=function(e,t){return(y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var v=function(){return(v=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function g(e){return Object.keys(e).some(function(t){var r=e[t];if(!r)return!1;switch(r.constructor.name){case"Array":case"Object":case"Date":case"Function":case"Boolean":case"String":case"Number":return!1;default:return!0}})}function I(e){var t={};return Object.keys(e).forEach(function(r){var n=e[r];if(n||0===n||"boolean"==typeof n||"string"==typeof n){var o;switch(n.constructor.name){case"Array":o=n[0]&&n[0].constructor&&"Object"===n[0].constructor.name?JSON.stringify(n):n.join(",");break;case"Object":o=JSON.stringify(n);break;case"Date":o=n.valueOf();break;case"Function":o=null;break;case"Boolean":o=n+"";break;default:o=n}(o||0===o||"string"==typeof o)&&(t[r]=o)}}),t}function w(e){var t=I(e);return Object.keys(t).map(function(e){return function(e,t){return encodeURIComponent(e)+"="+encodeURIComponent(t)}(e,t[e])}).join("&")}var b=function(){return function(e,t,r,n,o){e=e||"UNKNOWN_ERROR",t=t||"UNKNOWN_ERROR_CODE",this.name="ArcGISRequestError",this.message="UNKNOWN_ERROR_CODE"===t?e:t+": "+e,this.originalMessage=e,this.code=t,this.response=r,this.url=n,this.options=o}}();b.prototype=Object.create(Error.prototype),b.prototype.constructor=b;var O="@esri/arcgis-rest-js";function T(e,t){void 0===t&&(t={params:{f:"json"}});var r=v({httpMethod:"POST"},t),n=[],o=[];if(r.fetch||"undefined"==typeof fetch?(n.push("`fetch`"),o.push("`isomorphic-fetch`")):r.fetch=fetch.bind(Function("return this")()),"undefined"==typeof Promise&&(n.push("`Promise`"),o.push("`es6-promise`")),"undefined"==typeof FormData&&(n.push("`FormData`"),o.push("`isomorphic-form-data`")),!r.fetch||"undefined"==typeof Promise||"undefined"==typeof FormData)throw new Error("`arcgis-rest-request` requires global variables for `fetch`, `Promise` and `FormData` to be present in the global scope. You are missing "+n.join(", ")+". We recommend installing the "+o.join(", ")+" modules at the root of your application to add these to the global scope. See https://bit.ly/2KNwWaJ for more info.");var i=r.httpMethod,a=r.authentication,s=v({f:"json"},t.params),u={method:i,credentials:"same-origin"};return(a?a.getToken(e,{fetch:r.fetch}):Promise.resolve("")).then(function(n){if(n.length&&(s.token=n),"GET"===u.method){var o=""===w(s)?e:e+"?"+w(s);r.maxUrlLength&&o.length>r.maxUrlLength?u.method="POST":e=o}return"POST"===u.method&&(u.body=function(e){var t=g(e),r=I(e);if(t){var n=new FormData;return Object.keys(r).forEach(function(e){if("undefined"!=typeof Blob&&r[e]instanceof Blob){var t=r.fileName||r[e].name||e;n.append(e,r[e],t)}else n.append(e,r[e])}),n}return w(e)}(s)),u.headers=v({},t.headers),"undefined"!=typeof window||u.headers.referer||(u.headers.referer=O),g(s)||(u.headers["Content-Type"]="application/x-www-form-urlencoded"),r.fetch(e,u)}).then(function(t){if(!t.ok){var n=t.status,o=t.statusText;throw new b(o,"HTTP "+n,t,e,r)}switch(s.f){case"json":case"geojson":return t.json();case"html":case"text":return t.text();default:return t.blob()}}).then(function(t){return"json"===s.f||"geojson"===s.f?function(e,t,r,n){if(e.code>=400){var o=e.message,i=e.code;throw new b(o,i,e,t,n)}if(e.error){var a=e.error,o=a.message,i=a.code,s=a.messageCode,u=s||i||"UNKNOWN_ERROR_CODE";if(498===i||499===i||"GWM_0003"===s)throw new A(o,u,e,t,n);throw new b(o,u,e,t,n)}if("failed"===e.status||"failure"===e.status){var o=void 0,i="UNKNOWN_ERROR_CODE";try{o=JSON.parse(e.statusMessage).message,i=JSON.parse(e.statusMessage).code}catch(t){o=e.statusMessage||e.message}throw new b(o,i,e,t,n)}return e}(t,e,0,r):t})}var E,A=function(e){function t(t,r,n,o,i){void 0===t&&(t="AUTHENTICATION_ERROR"),void 0===r&&(r="AUTHENTICATION_ERROR_CODE");var a=e.call(this,t,r,n,o,i)||this;return a.name="ArcGISAuthError",a.message="AUTHENTICATION_ERROR_CODE"===r?t:r+": "+t,a}return function(e,t){function r(){this.constructor=e}y(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t.prototype.retry=function(e,t){var r=this;void 0===t&&(t=3);var n=0,o=function(i,a){e(r.url,r.options).then(function(e){var t=v({},r.options,{authentication:e});return n+=1,T(r.url,t)}).then(function(e){i(e)}).catch(function(e){"ArcGISAuthError"===e.name&&n<t?o(i,a):"ArcGISAuthError"===e.name&&n>=t?a(r):a(e)})};return new Promise(function(e,t){o(e,t)})},t}(b);function P(e){return"/"===(e=e.trim())[e.length-1]&&(e=e.slice(0,-1)),e}function k(e){return void 0===e&&(e={}),e.portal?P(e.portal):e.authentication?e.authentication.portal:"https://www.arcgis.com/sharing/rest"}function S(e){var t=JSON.parse(JSON.stringify(e)),r=e.typeKeywords,n=void 0===r?[]:r,o=e.tags,i=void 0===o?[]:o;return t.typeKeywords=n.join(", "),t.tags=i.join(", "),t.data&&(t.text=JSON.stringify(t.data),delete t.data),t.properties&&(t.properties=JSON.stringify(t.properties)),t}function x(e){return e.owner?e.owner:e.item&&e.item.owner?e.item.owner:e.authentication.username}function j(e){var t=x(e),r=k(e)+"/content/users/"+t,n=r+"/addItem";return e.folder&&(n=r+"/"+e.folder+"/addItem"),e.params=v({},e.params,S(e.item)),T(n,e)}function R(e){var t=x(e),r=k(e)+"/content/users/"+t+"/items/"+e.item.id+"/update";return e.params=v({},e.params,S(e.item)),T(r,e)}function C(e){var t,r,n,o,i=k(e)+"/community/createGroup",a=v({},e);return a.params=(t=e.group,r=JSON.parse(JSON.stringify(t)),n=t.tags,o=void 0===n?[]:n,r.tags=o.join(", "),r),T(i,a)}function D(e,t){return T(k(t)+"/community/groups/"+e,v({httpMethod:"GET"},t))}function N(e){return e.authentication.getUser(e).then(function(e){return!(!e||"org_admin"!==e.role)})}function _(e){var t=function(e){var t=e.authentication.username,r=e.owner||t;return k(e)+"/content/users/"+encodeURIComponent(r)+"/items/"+e.id+"/share"}(e);return function(e){var t=e.authentication.username;return(e.owner||t)===t}(e)?F(t,e):N(e).then(function(r){if(r)return F(t,e);throw Error("This item can not be shared by "+e.authentication.username+". They are neither the item owner nor an organization admin.")})}function F(e,t){return t.params=v({org:!1,everyone:!1},t.params),"private"===t.access&&(t.params.groups=" "),"org"===t.access&&(t.params.org=!0),"public"===t.access&&(t.params.org=!0,t.params.everyone=!0),T(e,t)}function U(e){return function(e){var t=e.authentication.username,r=e.owner||t;return N(e).then(function(n){var o="share"===e.action?"notSharedWith":"notUnsharedFrom";return function(e){var t={q:"id: "+e.id+" AND group: "+e.groupId,start:1,num:10,sortField:"title"},r=v({},e);return r.params=v({},t,e.params),T(k(r)+"/search",r).then(function(t){return 0!==t.total&&(t.results.some(function(t){var n=t.id===e.id;return n&&(r=t),n}),!!r);var r})}(e).then(function(i){if("share"===e.action&&!0===i||"unshare"===e.action&&!1===i){var a={itemId:e.id,shortcut:!0};return a[o]=[],a}return function(e){return D(e.groupId,e).then(function(e){return e.userMembership.memberType}).catch(function(){return"nonmember"})}(e).then(function(o){if("nonmember"===o)throw Error("This item can not be "+e.action+"d by "+t+" as they are not a member of the specified group "+e.groupId+".");if(r===t||n)return k(e)+"/content/users/"+r+"/items/"+e.id+"/"+e.action;if("admin"===o||"owner"===o)return k(e)+"/content/items/"+e.id+"/"+e.action;throw Error("This item can not be "+e.action+"d by "+t+" as they are neither the owner, a groupAdmin of "+e.groupId+", nor an org_admin.")}).then(function(t){return e.params={groups:e.groupId,confirmItemControl:e.confirmItemControl},T(t,e)}).then(function(t){if(t[o].length)throw Error("Item "+e.id+" could not be "+e.action+"d to group "+e.groupId+".");return t})})})}(v({action:"share"},e))}!function(e){e.ArcGISRequestError="ArcGISRequestError",e.ArcGISAuthError="ArcGISAuthError"}(E||(E={}));var L="{{organization.portalBaseUrl}}";function W(e){e.item.extent&&(e.item.extent="{{initiative.extent:optional}}"),e.item.id=J(e.item.id)}function G(e,t,r,n,o){return void 0===n&&(n=null),void 0===o&&(o="private"),new Promise(function(i,a){var s=v({item:e,folder:n},r);t&&(s.item.text=t),j(s).then(function(t){(delete e.text,"private"!==o)?_(v({id:t.id,access:o},r)).then(function(e){i({success:!0,id:e.itemId})},function(e){return a({success:!1,error:e.error?e.error:e})}):i({success:!0,id:t.id})},function(e){return a({success:!1,error:e.error?e.error:e})})})}function M(e){return Array.isArray(e)?e.map(function(e){return M(e)}):e&&e.startsWith("{{")?e.substring(2,e.indexOf(".")):e}function z(e,t,r){r&&r({processId:e,status:t?"done":"failed"})}function B(){var e=new Date;return K(e.getUTCFullYear(),4)+K(e.getUTCMonth()+1,2)+K(e.getUTCDate(),2)+"_"+K(e.getUTCHours(),2)+K(e.getUTCMinutes(),2)+"_"+K(e.getUTCSeconds(),2)+K(e.getUTCMilliseconds(),3)}function K(e,t){var r=e.toString(),n=t-r.length;return n>0&&(r="0".repeat(n)+r),r}function J(e,t){return void 0===t&&(t="id"),Array.isArray(e)?function(e,t){void 0===t&&(t="id");return e.map(function(e){return J(e,t)})}(e,t):e&&e.startsWith("{{")?e:"{{"+e+"."+t+"}}"}function H(e,t,r){return new Promise(function(n,o){R(v({item:{id:e,url:t}},r)).then(function(t){n(e)},function(e){return o({error:e.error?e.error:e})})})}function $(e,t){return t.split(".").reduce(function(e,t){return e?e[t]:void 0},e)}function q(e,t){return t.reduce(function(t,r){var n=$(e,r);return n&&t.push(n),t},[])}function V(e,t){var r,n=[];if(!e)return n;for(r in e)e.hasOwnProperty(r)&&(r===t?n.push(e[r]):Array.isArray(e[r])?e[r].forEach(function(e){n=n.concat(V(e,t))}):"object"==typeof e[r]&&(n=n.concat(V(e[r],t))));return n}function Y(e,t){return($(e,"item.typeKeywords")||e.typeKeywords||[]).includes(t)}function Q(e){return void 0===e&&(e="i"),""+e+Math.random().toString(36).substr(2,8)}var X="/apps/opsdashboard/index.html#/";function Z(e){var t=[],r=$(e,"data.widgets");return r&&r.forEach(function(e){"mapWidget"===e.type&&t.push(e.itemId)}),t}var ee=Object.freeze({OPS_DASHBOARD_APP_URL_PART:X,convertItemToTemplate:function(e,t){return new Promise(function(t){e.estimatedDeploymentCostFactor=4,W(e),e.item.url=L+X,e.dependencies=Z(e),t(e)})},createItemFromTemplate:function(e,t,r,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var a=v({item:e.item,folder:t.folderId},r);e.data&&(a.item.text=e.data),n&&n({processId:e.key,status:"creating"}),j(a).then(function(a){a.success?(t[e.itemId]={id:a.id},e.itemId=e.item.id=a.id,e=h(e,t),n&&n({processId:e.key,status:"updating URL"}),H(e.itemId,e.item.url,r).then(function(){z(e.key,!0,n),o(e)},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})):(z(e.key,!1,n),i({success:!1}))},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})})},extractDependencies:Z});function te(e,t,r){return new Promise(function(n,o){if(e.dependencies.length>0){var i=[];e.dependencies.forEach(function(n){i.push(new Promise(function(o,i){U(v({id:n,groupId:e.itemId},t)).then(function(){r&&r({processId:e.key,status:"added group member"}),o()},function(t){z(e.key,!1,r),i({success:!1,error:t.error?t.error:t})})}))}),Promise.all(i).then(function(){return n()},function(e){return o({success:!1,error:e.error?e.error:e})})}else n()})}function re(e,t){return new Promise(function(r,n){var o=v({paging:{start:1,num:100}},t);ne(e.itemId,o).then(function(t){e.estimatedDeploymentCostFactor=3+t.length,r(t)},function(e){return n({success:!1,error:e.error?e.error:e})})})}function ne(e,t){return new Promise(function(r,n){(function(e,t){var r=k(t)+"/content/groups/"+e,n=v({httpMethod:"GET"},{params:{start:1,num:100}},t);return t&&t.paging&&(n.params=v({},t.paging)),T(r,n)})(e,t).then(function(o){if(o.num>0){var i=o.items.map(function(e){return e.id});o.nextStart>0?(t.paging.start=o.nextStart,ne(e,t).then(function(e){r(i.concat(e))},function(e){return n({success:!1,error:e.error?e.error:e})})):r(i)}else r([])},function(e){return n({success:!1,error:e.error?e.error:e})})})}var oe=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(r,n){e.estimatedDeploymentCostFactor=3,W(e),re(e,t).then(function(t){e.dependencies=t,r(e)},function(e){return n({success:!1,error:e.error?e.error:e})})})},createItemFromTemplate:function(e,t,r,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var a=v({group:e.item},r);a.group.title+="_"+B(),n&&n({processId:e.key,status:"creating"}),C(a).then(function(a){a.success?(t[e.itemId]={id:a.group.id},e.itemId=a.group.id,te(e=h(e,t),r,n).then(function(){z(e.key,!0,n),o(e)},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})):(z(e.key,!1,n),i({success:!1}))},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})})},addGroupMembers:te,getGroupContents:re,getGroupContentsTranche:ne});function ie(e){var t=x(e),r=k(e)+"/content/users/"+t+"/createService";return e.params=v({createParameters:e.item,outputType:"featureService"},e.params),e.folderId&&"/"!==e.folderId?T(r,e).then(function(t){if(t.success)return function(e){var t=x(e),r=k(e)+"/content/users/"+t+"/items/"+e.itemId+"/move",n=e.folderId;return n||(n="/"),e.params=v({folder:n},e.params),T(r,e)}({itemId:t.itemId,folderId:e.folderId,authentication:e.authentication}).then(function(e){if(e.success)return t;throw Error("A problem was encountered when trying to move the service to a different folder.")});throw Error("A problem was encountered when trying to create the service.")}):T(r,e)}function ae(e,t){var r=P(e).replace("/rest/services","/rest/admin/services")+"/addToDefinition";return t.params=v({addToDefinition:{}},t.params),t.layers&&t.layers.length>0&&(t.params.addToDefinition.layers=t.layers),t.tables&&t.tables.length>0&&(t.params.addToDefinition.tables=t.tables),T(r,t)}function se(e,t,r,n){return new Promise(function(o,i){var a=e.properties,s=[];(a.layers||[]).forEach(function(e){s[e.id]={item:e,type:"layer"}}),(a.tables||[]).forEach(function(e){s[e.id]={item:e,type:"table"}});var u={};s.length>0?function e(t,r,n,o,i,a,s,u){return new Promise(function(c,f){if(n.length>0){var d=n.shift(),m=d.item,l=m.id;delete m.serviceItemId,Array.isArray(m.relationships)&&m.relationships.length>0&&(i[l]=m.relationships,m.relationships=[]);var p=v({},a);"layer"===d.type?(m.adminLayerInfo={geometryField:{name:"Shape",srid:102100}},p.layers=[m]):p.tables=[m],ae(r,p).then(function(){u&&u({processId:s,status:"added layer"}),e(t,r,n,o,i,a,s,u).then(function(){return c()},function(e){return f({success:!1,error:e.error?e.error:e})})},function(e){return f({success:!1,error:e.error?e.error:e})})}else c()})}(e.itemId,e.item.url,s,t,u,r,e.key,n).then(function(){var t=[];Object.keys(u).forEach(function(o){t.push(new Promise(function(t,i){var a=v({params:{updateFeatureServiceDefinition:{relationships:u[o]}}},r);ae(e.item.url+"/"+o,a).then(function(){n&&n({processId:e.key,status:"updated relationship"}),t()},function(e){return i(e)})}))}),Promise.all(t).then(function(){return o()},function(e){return i({success:!1,error:e.error?e.error:e})})},function(e){return i({success:!1,error:e.error?e.error:e})}):o()})}function ue(e){return e.reduce(function(e,t){return e+(t.relationships?t.relationships.length:0)},0)}function ce(e,t){return new Promise(function(r,n){var o={service:{},layers:[],tables:[]},i=e.item.url;e.item.url=J(e.itemId,"url"),T(i+"?f=json",t).then(function(a){a.serviceItemId=J(a.serviceItemId),o.service=a,Promise.all([fe(i,a.layers,t),fe(i,a.tables,t)]).then(function(t){o.layers=t[0],o.tables=t[1],e.properties=o,e.estimatedDeploymentCostFactor+=o.layers.length+ue(o.layers)+o.tables.length+ue(o.tables),r()},function(e){return n({success:!1,error:e.error?e.error:e})})},function(e){return n({success:!1,error:e.error?e.error:e})})})}function fe(e,t,r){return new Promise(function(n,o){Array.isArray(t)&&0!==t.length||n([]);var i=[];t.forEach(function(t){i.push(T(e+"/"+t.id+"?f=json",r))}),Promise.all(i).then(function(e){e.forEach(function(e){e.editFieldsInfo=null,e.serviceItemId=J(e.serviceItemId)}),n(e)},function(e){return o({success:!1,error:e.error?e.error:e})})})}var de=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(r,n){e.estimatedDeploymentCostFactor=3,W(e),ce(e,t).then(function(){return r(e)},function(e){return n({success:!1,error:e.error?e.error:e})})})},createItemFromTemplate:function(e,t,r,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var a=v({item:e.item,folderId:t.folderId},r);e.data&&(a.item.text=e.data),a.item.name=e.item.name+"_"+B(),n&&n({processId:e.key,status:"creating"}),ie(a).then(function(a){t[e.itemId]={id:a.serviceItemId,url:a.serviceurl},e.itemId=e.item.id=a.serviceItemId,(e=h(e,t)).item.url=a.serviceurl,R(v({item:{id:e.itemId,title:e.item.title,snippet:e.item.snippet,description:e.item.description,accessInfo:e.item.accessInfo,licenseInfo:e.item.licenseInfo,text:e.data}},r)).then(function(){se(e,t,r,n).then(function(){z(e.key,!0,n),o(e)},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})})},addFeatureServiceLayersAndTables:se,countRelationships:ue,fleshOutFeatureService:ce,getLayers:fe}),me="/home/webmap/viewer.html?webmap=";function le(e){var t=[];return e.data&&(t=pe(e.data.operationalLayers).concat(pe(e.data.tables))),t}function pe(e){return void 0===e&&(e=[]),e.reduce(function(e,t){var r=t.itemId;return r&&e.push(r),e},[])}function he(e){void 0===e&&(e=[]),e.filter(function(e){return!!e.itemId}).forEach(function(e){var t=e.url.substr(e.url.lastIndexOf("/"));e.itemId=J(e.itemId),e.url=J(M(e.itemId),"url")+t})}var ye=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(t){e.estimatedDeploymentCostFactor=4,W(e),e.item.url=L+me+J(e.itemId),e.dependencies=le(e),e.data&&(he(e.data.operationalLayers),he(e.data.tables)),t(e)})},createItemFromTemplate:function(e,t,r,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var a=v({item:e.item,folder:t.folderId},r);e.data&&(a.item.text=e.data),n&&n({processId:e.key,status:"creating"}),j(a).then(function(a){a.success?(t[e.itemId]={id:a.id},e.itemId=e.item.id=a.id,e=h(e,t),n&&n({processId:e.key,status:"updating URL"}),H(e.itemId,e.item.url,r).then(function(){z(e.key,!0,n),o(e)},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})):(z(e.key,!1,n),i({success:!1}))},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})})},extractDependencies:le,getWebmapLayerIds:pe,templatizeWebmapLayerIdsAndUrls:he});function ve(e){var t=function(e){return[]};return Y(e,"Cascade")&&(t=ge),Y(e,"MapJournal")&&(t=we),Y(e,"mapseries")&&(t=Ie),t(e)}function ge(e){return($(e,"data.values.sections")||[]).reduce(function(e,t){return e.concat(V(t,"webmap").map(function(e){return e.id}))},[])}function Ie(e){var t=q(e,["data.values.webmap"]);return($(e,"data.values.story.entries")||[]).forEach(function(e){V(e,"webmap").map(function(e){return e.id}).forEach(function(e){-1===t.indexOf(e)&&t.push(e)})}),t}function we(e){return($(e,"data.values.story.sections")||[]).reduce(function(e,t){if(t.media){if("webmap"===t.media.type){var r=$(t,"media.webmap.id");r&&e.push(r)}if("webpage"===t.media.type){var n=function(e){var t=null;if(!e)return t;var r=e.split("?")[1];return r&&(t=r.split("&").reduce(function(e,t){var r,n=t.split("=")[1];return n&&"string"==typeof(r=n)&&("{"===r[0]&&(r=r.substring(1,r.length-1)),/^(\{){0,1}[0-9a-fA-F]{8}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{12}(\}){0,1}$/gi.test(r))&&(e=n),e},null)),t}($(t,"media.webpage.url"));n&&e.push(n)}}return e},[])}function be(e){var t=[],r=$(e,"data.map.itemId");return r&&t.push(r),t}function Oe(e){var t=Te;return Y(e,"Story Map")&&(t=ve),function(e,t){var r=$(e,"item.typeKeywords")||e.typeKeywords||[];return t.reduce(function(e,t){return e||(e=r.includes(t)),e},!1)}(e,["WAB2D","WAB3D","Web AppBuilder"])&&(t=be),t(e)}function Te(e){return q(e,["data.webmap","data.itemId","data.values.webmap","data.values.group"])}var Ee=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(t){e.estimatedDeploymentCostFactor=4,W(e);var r=e.item.url,n=r.indexOf("//");e.item.url=L+r.substring(r.indexOf("/",n+2),r.lastIndexOf("=")+1)+J(e.itemId),$(e,"data.folderId")&&(e.data.folderId="{{folderId}}"),e.dependencies=Oe(e),$(e,"data.values.webmap")?e.data.values.webmap=J(e.data.values.webmap):$(e,"data.values.group")&&(e.data.values.group=J(e.data.values.group)),t(e)})},createItemFromTemplate:function(e,t,r,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var a=v({item:e.item,folder:t.folderId},r);e.data&&(a.item.text=e.data),n&&n({processId:e.key,status:"creating"}),j(a).then(function(a){a.success?(t[e.itemId]={id:a.id},e.itemId=e.item.id=a.id,e=h(e,t),n&&n({processId:e.key,status:"updating URL"}),H(e.itemId,e.item.url,r).then(function(){z(e.key,!0,n),o(e)},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})):(z(e.key,!1,n),i({success:!1}))},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})})},extractDependencies:Oe,getGenericWebAppDependencies:Te});var Ae=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(t){W(e),t(e)})},createItemFromTemplate:function(e,t,r,n){return n&&n({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,i){var a=v({item:e.item,folder:t.folderId},r);e.data&&(a.item.text=e.data),n&&n({processId:e.key,status:"creating"}),j(a).then(function(r){r.success?(t[e.itemId]={id:r.id},e.itemId=e.item.id=r.id,z((e=h(e,t)).key,!0,n),o(e)):(z(e.key,!1,n),i({success:!1}))},function(t){z(e.key,!1,n),i({success:!1,error:t.error?t.error:t})})})}}),Pe={dashboard:ee,"feature service":de,group:oe,"web map":ye,"web mapping application":Ee};function ke(e,t){return new Promise(function(r,n){var o;(function(e,t){return T(k(t)+"/content/items/"+e,v({httpMethod:"GET"},t))})(e,t).then(function(i){Pe[i.type.toLowerCase()]||console.warn("Unimplemented item type "+i.type+" for "+e),(o={itemId:i.id,type:i.type,key:Q(),item:xe(i),dependencies:[],fcns:Pe[i.type.toLowerCase()]||Ae,estimatedDeploymentCostFactor:3}).item.id=J(o.item.id),o.item.item&&(o.item.item=J(o.item.item)),o.item.thumbnail="https://www.arcgis.com/sharing/content/items/"+e+"/info/"+o.item.thumbnail;var a=function(e,t){var r=k(t)+"/content/items/"+e+"/data",n=v({httpMethod:"GET",params:{}},t);return n.file&&(n.params.f=null),T(r,n)}(e,t),s=function(e){var t=k(e)+"/content/items/"+e.id+"/resources";return e.params=v({},e.params,{num:1e3}),T(t,e)}(v({id:e},t));Promise.all([a.catch(function(){return null}),s.catch(function(){return null})]).then(function(e){var i=e[0],a=e[1];o.data=i,o.resources=a&&a.total>0?a.resources:null,o.fcns.convertItemToTemplate(o,t).then(function(e){o.dependencies=Se(function(e){void 0===e&&(e=[]);return e.reduce(function(e,t){return e.concat(t)},[])}(e.dependencies)),r(o)},function(e){return n({success:!1,error:e.error?e.error:e})})})},function(){D(e,t).then(function(i){(o={itemId:i.id,type:"Group",key:Q(),item:xe(i),dependencies:[],fcns:Pe.group,estimatedDeploymentCostFactor:3}).item.thumbnail="https://www.arcgis.com/sharing/content/items/"+e+"/info/"+o.item.thumbnail,o.fcns.convertItemToTemplate(o,t).then(function(e){o.dependencies=Se(e.dependencies),r(o)},function(e){return n({success:!1,error:e.error?e.error:e})})},function(e){return n({success:!1,error:e.error?e.error:e})})})})}function Se(e){void 0===e&&(e=[]);var t={};return e.forEach(function(e){return t[e]=!0}),Object.keys(t)}function xe(e){if(e){var t=v({},e);return delete t.avgRating,delete t.created,delete t.guid,delete t.lastModified,delete t.modified,delete t.numComments,delete t.numRatings,delete t.numViews,delete t.orgId,delete t.owner,delete t.scoreCompleteness,delete t.size,delete t.uploaded,t}return null}var je;function Re(e,t,r,n,o){return void 0===n&&(n={}),void 0===o&&(o="private"),new Promise(function(i,a){var s=t.item,u="https://www.arcgis.com/sharing/content/items/"+s.id+"/info/"+s.thumbnail;G({itemType:"text",name:null,title:e,description:s.description,tags:s.tags,snippet:s.snippet,thumbnailurl:u,accessInformation:s.accessInformation,type:"Solution",typeKeywords:["Solution","Deployed"],commentsEnabled:!1},null,r,n.folderId,o).then(function(e){var t=n.organization&&n.organization.orgUrl||"https://www.arcgis.com",r={id:e.id,url:t+"/home/item.html?id="+e.id};i(r)},function(e){return a({success:!1,error:e.error?e.error:e})})})}function Ce(e,t,r,n,o){n[e]={};var i=new Promise(function(i,a){var s=Fe(t,e);s||a({success:!1});var u=[];(s.dependencies||[]).forEach(function(e){return u.push(n[e].def)}),Promise.all(u).then(function(){var s=function(e){return e.fcns=Pe[e.type.toLowerCase()]||Ae,e}(Fe(t,e));s.dependencies=s.dependencies?J(s.dependencies):[],(s=h(s,n)).fcns.createItemFromTemplate(s,n,r,o).then(function(e){return i(e)},function(e){return a({success:!1,error:e.error?e.error:e})})},function(e){return a({success:!1,error:e.error?e.error:e})})});return n[e].def=i,i}function De(e,t,r,n){return n||(n=[]),new Promise(function(o,i){if("string"==typeof e){var a=e;if(Fe(n,a))o(n);else{var s=ke(a,r);n.push({itemId:a,type:"",key:"",item:null}),s.then(function(e){if(Ue(n,e.itemId,e),0===e.dependencies.length)o(n);else{var a=[];e.dependencies.forEach(function(e){Fe(n,e)||a.push(De(e,t,r,n))}),Promise.all(a).then(function(){o(n)},function(e){return i({success:!1,error:e.error?e.error:e})})}},function(e){return i({success:!1,error:e.error?e.error:e})})}}else if(Array.isArray(e)&&e.length>0){var u=[];e.forEach(function(e){u.push(De(e,t,r,n))}),Promise.all(u).then(function(){o(n)},function(e){return i({success:!1,error:e.error?e.error:e})})}else i({success:!1})})}function Ne(e,t,r,n,o){return void 0===n&&(n={}),void 0===o&&(o="private"),new Promise(function(i,a){var s={item:{itemType:"text",name:null,title:e,type:"Solution",typeKeywords:["Solution","Template"],commentsEnabled:!1},data:{metadata:{version:t},templates:[]}};G(s.item,s.data,r,n.folderId,o).then(function(e){var t=n.organization&&n.organization.orgUrl||"https://www.arcgis.com";s.item.id=e.id,s.item.url=t+"/home/item.html?id="+e.id,i(s)},function(e){return a({success:!1,error:e.error?e.error:e})})})}function _e(e,t){var r=t;return e.findIndex(function(e){return r===e.itemId})}function Fe(e,t){var r=_e(e,t);return r>=0?e[r]:null}function Ue(e,t,r){var n=_e(e,t);return n>=0&&(e[n]=r,!0)}function Le(e){var t=[],r={};return e.forEach(function(e){r[e.itemId]=je.White}),e.forEach(function(n){r[n.itemId]===je.White&&function n(o){r[o]=je.Gray;var i=Fe(e,o);var a=i.dependencies||[];a.forEach(function(e){if(r[e]===je.White)n(e);else if(r[e]===je.Gray)throw Error("Cyclical dependency graph detected")});r[o]=je.Black;t.push(o)}(n.itemId)}),t}function We(e){var t=e.map(function(e){return e.itemId});return e.forEach(function(e){(e.dependencies||[]).forEach(function(e){var r=t.indexOf(e);r>=0&&t.splice(r,1)})}),t}!function(e){e[e.White=0]="White",e[e.Gray=1]="Gray",e[e.Black=2]="Black"}(je||(je={})),e.createSolutionItem=function(e,t,r,n,o){return new Promise(function(i,a){o||(o=n),Ne(e,t,o,void 0,"public").then(function(e){De(r,e,n).then(function(t){e.data.templates=t,function(e,t){return new Promise(function(r,n){(function(e,t,r){return new Promise(function(n,o){R(v({item:{id:e,text:t}},r)).then(function(t){n(e)},function(e){return o({error:e.error?e.error:e})})})})(e.item.id,e.data,t).then(function(){return r(e)},function(e){return n({success:!1,error:e.error?e.error:e})})})}(e,o).then(function(e){i(e)},function(e){return a({success:!1,error:e.error?e.error:e})})},function(e){return a({success:!1,error:e.error?e.error:e})})},function(e){return a({success:!1,error:e.error?e.error:e})})})},e.deploySolutionItem=function(e,t,r,n){return void 0===r&&(r={}),new Promise(function(o,i){var a=$(e,"data.templates");r.solutionName=r.solutionName||"Solution",a&&0!==Object.keys(a).length||o([]);var s=Le(a);function u(){Re(r.solutionName,e,t,r,"public").then(function(e){var u;n&&n({processId:e.id,type:"Solution",status:"done"}),u=[],s.forEach(function(e){return u.push(Ce(e,a,t,r,n))}),Promise.all(u).then(function(e){return o(e)},function(e){return i({success:!1,error:e.error?e.error:e})})},function(e){return i({success:!1,error:e.error?e.error:e})})}r.folderId?u():function(e){var t=x(e),r=k(e)+"/content/users/"+t+"/createFolder";return e.params=v({title:e.title},e.params),T(r,e)}({title:r.solutionName+" ("+B()+")",authentication:t.authentication}).then(function(e){r.folderId=e.folder.id,u()},function(e){return i({success:!1,error:e.error?e.error:e})})})},e.getEstimatedDeploymentCost=function(e){return e.reduce(function(e,t){return e+(t.estimatedDeploymentCostFactor?t.estimatedDeploymentCostFactor:3)},0)},e.getSupportedItemTypes=function(){return Object.keys(Pe)},e.PLACEHOLDER_SERVER_NAME="{{organization.portalBaseUrl}}",e.OPS_DASHBOARD_APP_URL_PART="/apps/opsdashboard/index.html#/",e.WEBMAP_APP_URL_PART="/home/webmap/viewer.html?webmap=",e.createDeployedSolutionAgoItem=Re,e.createItemFromTemplateWhenReady=Ce,e.createItemTemplates=De,e.createSolutionAgoItem=Ne,e.findTemplateInList=Fe,e.publishSolutionTemplate=function(e,t,r,n,o){return void 0===n&&(n=null),void 0===o&&(o="private"),G({title:e,type:"Solution",itemType:"text",typeKeywords:["Template"],access:o,listed:!1,commentsEnabled:!1},{templates:t},r,n,o)},e.replaceTemplate=Ue,e.topologicallySortItems=Le,e.getItemHierarchy=function(e){var t=[];return function t(r,n){r.forEach(function(r){var o={id:r,dependencies:[]},i=Fe(e,r).dependencies;Array.isArray(i)&&i.length>0&&t(i,o.dependencies),n.push(o)})}(We(e),t),t},e.getTopLevelItemIds=We,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=arcgis-clone.umd.min.js.map
